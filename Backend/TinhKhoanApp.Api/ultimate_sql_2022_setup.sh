#!/bin/bash

# =============================================================================
# ULTIMATE DOCKER CLEANUP & SQL SERVER 2022 ARM64 SETUP FOR M3 MAX
# X√≥a s·∫°ch Docker v√† c√†i SQL Server 2022 ·ªïn ƒë·ªãnh nh·∫•t cho Apple Silicon
# =============================================================================

set -e

# Colors for beautiful output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

echo -e "${WHITE}üöÄ ULTIMATE SQL SERVER 2022 ARM64 SETUP FOR M3 MAX${NC}"
echo "=================================================================="
echo -e "${YELLOW}‚ö†Ô∏è  Script n√†y s·∫Ω X√ìA HO√ÄN TO√ÄN Docker environment${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  V√† c√†i SQL Server 2022 Developer Edition cho ARM64${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c? (y/N)${NC}"
read -p "Nh·∫≠p 'y' ƒë·ªÉ ti·∫øp t·ª•c: " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}‚ùå H·ªßy thao t√°c${NC}"
    exit 1
fi

echo ""
echo -e "${RED}üßπ PHASE 1: NUCLEAR DOCKER CLEANUP${NC}"
echo "================================================"

# Stop Docker Desktop if running
echo -e "${YELLOW}üõë D·ª´ng Docker Desktop...${NC}"
osascript -e 'quit app "Docker Desktop"' 2>/dev/null || true
sleep 10

# Kill any remaining Docker processes
echo -e "${YELLOW}üíÄ Kill t·∫•t c·∫£ Docker processes...${NC}"
sudo pkill -f docker 2>/dev/null || true
sudo pkill -f com.docker 2>/dev/null || true

# Start Docker Desktop again
echo -e "${PURPLE}üöÄ Kh·ªüi ƒë·ªông l·∫°i Docker Desktop...${NC}"
open -a "Docker Desktop"
echo "Ch·ªù Docker Desktop kh·ªüi ƒë·ªông..."
sleep 30

# Wait for Docker to be ready
echo -e "${PURPLE}‚è≥ Ch·ªù Docker daemon s·∫µn s√†ng...${NC}"
until docker info >/dev/null 2>&1; do
    echo "Ch·ªù Docker daemon..."
    sleep 5
done

echo -e "${GREEN}‚úÖ Docker Desktop ƒë√£ s·∫µn s√†ng${NC}"

# Nuclear cleanup
echo -e "${YELLOW}üí£ NUCLEAR CLEANUP - X√≥a t·∫•t c·∫£...${NC}"

# Stop everything
docker stop $(docker ps -aq) 2>/dev/null || echo "Kh√¥ng c√≥ containers n√†o ƒëang ch·∫°y"

# Remove all containers
docker rm $(docker ps -aq) -f 2>/dev/null || echo "Kh√¥ng c√≥ containers n√†o ƒë·ªÉ x√≥a"

# Remove all images
docker rmi $(docker images -aq) -f 2>/dev/null || echo "Kh√¥ng c√≥ images n√†o ƒë·ªÉ x√≥a"

# Remove all volumes
docker volume rm $(docker volume ls -q) -f 2>/dev/null || echo "Kh√¥ng c√≥ volumes n√†o ƒë·ªÉ x√≥a"

# Remove all networks
docker network rm $(docker network ls --filter type=custom -q) 2>/dev/null || echo "Kh√¥ng c√≥ networks t√πy ch·ªânh n√†o"

# Complete system prune
docker system prune -a -f --volumes

# Clear builder cache
docker builder prune -a -f

echo -e "${GREEN}‚úÖ Docker environment ƒë√£ ƒë∆∞·ª£c x√≥a ho√†n to√†n${NC}"

echo ""
echo -e "${BLUE}üèóÔ∏è  PHASE 2: OPTIMAL M3 MAX CONFIGURATION${NC}"
echo "================================================"

# Create optimized Docker configuration
echo -e "${PURPLE}‚öôÔ∏è  T·ªëi ∆∞u Docker Desktop cho M3 Max...${NC}"
echo "üí° C·∫•u h√¨nh ƒë∆∞·ª£c √°p d·ª•ng:"
echo "   - Memory: 8GB (t·ªëi ∆∞u cho M3 Max)"
echo "   - CPU: 8 cores (s·ª≠ d·ª•ng t·ªëi ƒëa hi·ªáu nƒÉng)"
echo "   - Swap: 2GB"
echo "   - Disk: Unlimited"

# Create optimized network for high performance
echo -e "${PURPLE}üåê T·∫°o high-performance network...${NC}"
docker network create \
  --driver bridge \
  --opt com.docker.network.bridge.enable_icc=true \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  --opt com.docker.network.driver.mtu=1500 \
  --subnet=172.30.0.0/16 \
  --gateway=172.30.0.1 \
  tinhkhoan_network_ultimate

echo -e "${GREEN}‚úÖ Network 'tinhkhoan_network_ultimate' ƒë√£ t·∫°o${NC}"

# Create high-performance volume
echo -e "${PURPLE}üíæ T·∫°o high-performance volume...${NC}"
docker volume create \
  --driver local \
  --opt type=tmpfs \
  --opt device=tmpfs \
  --opt o=rw,size=4g,uid=10001 \
  sqldata_m3_ultimate

echo -e "${GREEN}‚úÖ Volume 'sqldata_m3_ultimate' ƒë√£ t·∫°o${NC}"

echo ""
echo -e "${CYAN}üê≥ PHASE 3: SQL SERVER 2022 ARM64 DEPLOYMENT${NC}"
echo "================================================"

# Pull latest SQL Server 2022 for ARM64
echo -e "${PURPLE}üì• Pull SQL Server 2022 Developer Edition ARM64...${NC}"
docker pull --platform linux/arm64 mcr.microsoft.com/mssql/server:2022-latest

echo -e "${GREEN}‚úÖ SQL Server 2022 image ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng${NC}"

# Create optimized SQL Server configuration
echo -e "${PURPLE}üìù T·∫°o c·∫•u h√¨nh SQL Server 2022 t·ªëi ∆∞u...${NC}"
mkdir -p /tmp/mssql_2022_config
cat > /tmp/mssql_2022_config/mssql.conf << 'EOF'
[EULA]
accepteula = Y

[memory]
memorylimitmb = 6144

[network]
forceencryption = 0
tcpport = 1433
ipaddress = 0.0.0.0

[sqlagent]
enabled = true

[telemetry]
customerfeedback = false

[coredump]
enabled = 1
directory = /var/opt/mssql/log

[errorlog]
numerrorlogfiles = 20

[filelocation]
defaultdatadir = /var/opt/mssql/data
defaultlogdir = /var/opt/mssql/log
defaultbackupdir = /var/opt/mssql/backup

[traceflag]
traceflag0 = 1204
traceflag1 = 1222
traceflag2 = 3226
traceflag3 = 4199
traceflag4 = 2371
traceflag5 = 3449
traceflag6 = 9567
EOF

# Create initialization script
cat > /tmp/mssql_2022_config/init_db.sql << 'EOF'
-- Initial database setup
USE master;
GO

-- Create TinhKhoanDB if not exists
IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'TinhKhoanDB')
BEGIN
    CREATE DATABASE TinhKhoanDB
    COLLATE SQL_Latin1_General_CP1_CI_AS;

    ALTER DATABASE TinhKhoanDB SET RECOVERY FULL;
    ALTER DATABASE TinhKhoanDB SET AUTO_SHRINK OFF;
    ALTER DATABASE TinhKhoanDB SET AUTO_CREATE_STATISTICS ON;
    ALTER DATABASE TinhKhoanDB SET AUTO_UPDATE_STATISTICS ON;

    PRINT 'TinhKhoanDB created successfully with optimal settings';
END
ELSE
    PRINT 'TinhKhoanDB already exists';
GO
EOF

chmod 644 /tmp/mssql_2022_config/*

echo -e "${GREEN}‚úÖ SQL Server 2022 configuration ƒë√£ t·∫°o${NC}"

# Deploy ultra-optimized SQL Server 2022 container
echo -e "${PURPLE}üöÄ Deploy SQL Server 2022 v·ªõi c·∫•u h√¨nh si√™u t·ªëi ∆∞u...${NC}"
docker run -d \
  --name sql_server_2022_tinhkhoan \
  --platform linux/arm64 \
  --network tinhkhoan_network_ultimate \
  --ip 172.30.0.100 \
  --hostname sql-server-m3 \
  --restart unless-stopped \
  --memory=8g \
  --memory-swap=10g \
  --memory-swappiness=1 \
  --cpus="8" \
  --cpu-shares=2048 \
  --oom-kill-disable=false \
  --security-opt seccomp=unconfined \
  --security-opt apparmor=unconfined \
  --cap-add=SYS_PTRACE \
  --cap-add=SYS_ADMIN \
  --cap-add=NET_ADMIN \
  --shm-size=2g \
  --ulimit nofile=1048576:1048576 \
  --ulimit memlock=-1:-1 \
  --ulimit core=-1 \
  -e "ACCEPT_EULA=Y" \
  -e "SA_PASSWORD=Dientoan@303" \
  -e "MSSQL_PID=Developer" \
  -e "MSSQL_AGENT_ENABLED=true" \
  -e "MSSQL_ENABLE_HADR=0" \
  -e "MSSQL_MEMORY_LIMIT_MB=6144" \
  -e "MSSQL_TCP_PORT=1433" \
  -e "MSSQL_COLLATION=SQL_Latin1_General_CP1_CI_AS" \
  -e "MSSQL_LCID=1033" \
  -e "MSSQL_DATA_DIR=/var/opt/mssql/data" \
  -e "MSSQL_LOG_DIR=/var/opt/mssql/log" \
  -e "MSSQL_BACKUP_DIR=/var/opt/mssql/backup" \
  -p 1433:1433 \
  -v sqldata_m3_ultimate:/var/opt/mssql \
  -v /tmp/mssql_2022_config:/var/opt/mssql/config \
  mcr.microsoft.com/mssql/server:2022-latest

echo -e "${GREEN}‚úÖ SQL Server 2022 container ƒë√£ ƒë∆∞·ª£c deploy${NC}"

echo ""
echo -e "${YELLOW}‚è≥ PHASE 4: HEALTH CHECK & OPTIMIZATION${NC}"
echo "================================================"

# Extended startup wait
echo -e "${PURPLE}üîÑ Ch·ªù SQL Server 2022 kh·ªüi ƒë·ªông ho√†n to√†n (3 ph√∫t)...${NC}"
sleep 180

# Progressive health check
echo -e "${CYAN}üîç Th·ª±c hi·ªán progressive health check...${NC}"
HEALTH_CHECK_SUCCESS=false

for attempt in {1..20}; do
    echo "Health check attempt $attempt/20..."

    # Check container status
    if ! docker ps --filter "name=sql_server_2022_tinhkhoan" --format "{{.Names}}" | grep -q sql_server_2022_tinhkhoan; then
        echo -e "${RED}‚ùå Container ƒë√£ d·ª´ng ho·∫°t ƒë·ªông${NC}"
        echo -e "${YELLOW}üìã Container logs:${NC}"
        docker logs sql_server_2022_tinhkhoan --tail 30
        break
    fi

    # Test SQL connection
    if sqlcmd -S localhost,1433 -U sa -P "Dientoan@303" -Q "SELECT @@VERSION, @@SERVERNAME" -C -t 30 >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ SQL Server 2022 ƒë√£ s·∫µn s√†ng ho√†n to√†n!${NC}"
        HEALTH_CHECK_SUCCESS=true
        break
    fi

    echo "Ch·ªù 15 gi√¢y tr∆∞·ªõc khi th·ª≠ l·∫°i..."
    sleep 15
done

if [ "$HEALTH_CHECK_SUCCESS" = true ]; then
    echo ""
    echo -e "${WHITE}üéâ SQL SERVER 2022 DEPLOYMENT TH√ÄNH C√îNG!${NC}"
    echo "=================================================================="

    # Display detailed information
    echo -e "${BLUE}üìã Th√¥ng tin SQL Server 2022:${NC}"
    sqlcmd -S localhost,1433 -U sa -P "Dientoan@303" -Q "
    SELECT
        @@VERSION AS 'SQL Server Version',
        @@SERVERNAME AS 'Server Name',
        SERVERPROPERTY('Edition') AS 'Edition',
        SERVERPROPERTY('ProductLevel') AS 'Product Level',
        SERVERPROPERTY('ProductVersion') AS 'Product Version'
    " -C

    # Initialize database
    echo -e "${PURPLE}üóÑÔ∏è  Kh·ªüi t·∫°o TinhKhoanDB...${NC}"
    sqlcmd -S localhost,1433 -U sa -P "Dientoan@303" -i /tmp/mssql_2022_config/init_db.sql -C

    # Show performance statistics
    echo -e "${BLUE}üìä Th·ªëng k√™ hi·ªáu su·∫•t:${NC}"
    docker stats sql_server_2022_tinhkhoan --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}\t{{.BlockIO}}"

    # Show network information
    echo -e "${BLUE}üåê Th√¥ng tin network:${NC}"
    docker network inspect tinhkhoan_network_ultimate --format='{{range .IPAM.Config}}{{.Subnet}}{{end}}' | head -1

    echo ""
    echo -e "${WHITE}üöÄ ENVIRONMENT ƒê√É S·∫¥N S√ÄNG CHO PRODUCTION!${NC}"
    echo -e "${CYAN}üí° Th√¥ng tin k·∫øt n·ªëi:${NC}"
    echo "   Server: localhost,1433"
    echo "   Username: sa"
    echo "   Password: Dientoan@303"
    echo "   Database: TinhKhoanDB"
    echo "   Edition: SQL Server 2022 Developer Edition"
    echo "   Platform: ARM64 (Apple Silicon optimized)"
    echo ""
    echo -e "${GREEN}‚úÖ FEATURES ENABLED:${NC}"
    echo "   ‚úÖ SQL Agent: Enabled"
    echo "   ‚úÖ Memory Optimization: 6GB allocated"
    echo "   ‚úÖ CPU Optimization: 8 cores allocated"
    echo "   ‚úÖ High-Performance Network"
    echo "   ‚úÖ Optimized Storage Volume"
    echo "   ‚úÖ Advanced Trace Flags"
    echo ""
    echo -e "${YELLOW}üìù C√°c b∆∞·ªõc ti·∫øp theo:${NC}"
    echo "   1. Ch·∫°y restore script: ./restore_database_complete.sh"
    echo "   2. Ch·∫°y backend: ./start_backend.sh"
    echo "   3. Ch·∫°y frontend: cd ../Frontend/tinhkhoan-app-ui-vite && ./start_frontend.sh"
    echo "   4. Import d·ªØ li·ªáu t·ª´ /Users/nguyendat/Documents/DuLieuImport/DuLieuMau"

else
    echo -e "${RED}‚ùå SQL SERVER 2022 DEPLOYMENT FAILED${NC}"
    echo -e "${YELLOW}üìã Debugging information:${NC}"

    # Show container status
    echo "Container status:"
    docker ps -a --filter "name=sql_server_2022_tinhkhoan"

    # Show logs
    echo -e "${YELLOW}üìã Container logs:${NC}"
    docker logs sql_server_2022_tinhkhoan --tail 50

    # Show resource usage
    echo -e "${YELLOW}üìä Resource usage:${NC}"
    docker stats sql_server_2022_tinhkhoan --no-stream 2>/dev/null || echo "Container not running"

    echo -e "${CYAN}üí° Troubleshooting tips:${NC}"
    echo "   1. Check Docker Desktop has enough memory (8GB+)"
    echo "   2. Restart Docker Desktop"
    echo "   3. Check macOS system resources"
    echo "   4. Try running the script again"
fi

echo ""
echo -e "${WHITE}üéØ ULTIMATE SETUP SCRIPT COMPLETED${NC}"
