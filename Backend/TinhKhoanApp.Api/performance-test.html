<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinhKhoanApp - Performance Dashboard Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .metric-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 1.5em;
            color: #007bff;
            margin: 5px 0;
        }
        .export-progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .export-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ TinhKhoanApp - Performance Dashboard & Streaming Export Test</h1>
        
        <!-- Connection Status -->
        <div class="section">
            <h2>üì° System Status</h2>
            <p>Backend API: <span id="backendStatus" class="status offline">Checking...</span></p>
            <p>Frontend Vue: <span id="frontendStatus" class="status offline">Checking...</span></p>
            <p>Cache System: <span id="cacheStatus" class="status offline">Memory Cache</span></p>
        </div>

        <!-- Performance Metrics -->
        <div class="section">
            <h2>üìä Real-time Performance Metrics</h2>
            <button onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
            <button onclick="startAutoRefresh()">‚ñ∂Ô∏è Auto Refresh (5s)</button>
            <button onclick="stopAutoRefresh()">‚èπÔ∏è Stop Auto Refresh</button>
            
            <div class="metrics" id="metricsContainer">
                <!-- Metrics will be populated here -->
            </div>
        </div>

        <!-- Streaming Export Demo -->
        <div class="section">
            <h2>üì§ Streaming Export Demo</h2>
            <div>
                <button onclick="startEmployeeExport()">üë• Export Employees (CSV)</button>
                <button onclick="startEmployeeExportExcel()">üë• Export Employees (Excel)</button>
                <button onclick="startRawDataExport()">üìã Export Raw Data (CSV)</button>
            </div>
            
            <div id="exportStatus" style="margin: 10px 0;">
                Ready to export...
            </div>
            
            <div class="export-progress">
                <div class="export-progress-bar" id="exportProgressBar"></div>
            </div>
            
            <div>Progress: <span id="exportProgressText">0%</span></div>
        </div>

        <!-- Activity Log -->
        <div class="section">
            <h2>üìã Activity Log</h2>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            <div class="log" id="activityLog"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5055/api';
        const FRONTEND_URL = 'http://localhost:3000';
        let autoRefreshInterval = null;
        let exportAbortController = null;

        // Log function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
        }

        // Check system status
        async function checkSystemStatus() {
            try {
                // Check backend
                const backendResponse = await fetch(`${API_BASE}/performance-dashboard/system`);
                document.getElementById('backendStatus').textContent = backendResponse.ok ? 'Online' : 'Offline';
                document.getElementById('backendStatus').className = `status ${backendResponse.ok ? 'online' : 'offline'}`;
                
                // Check frontend
                try {
                    const frontendResponse = await fetch(FRONTEND_URL);
                    document.getElementById('frontendStatus').textContent = frontendResponse.ok ? 'Online' : 'Offline';
                    document.getElementById('frontendStatus').className = `status ${frontendResponse.ok ? 'online' : 'offline'}`;
                } catch {
                    document.getElementById('frontendStatus').textContent = 'Offline';
                    document.getElementById('frontendStatus').className = 'status offline';
                }
                
                log('System status checked');
            } catch (error) {
                log(`Error checking system status: ${error.message}`, 'error');
            }
        }

        // Refresh performance metrics
        async function refreshMetrics() {
            try {
                log('Fetching performance metrics...');
                const response = await fetch(`${API_BASE}/performance-dashboard/dashboard`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                displayMetrics(data);
                log('Performance metrics updated', 'success');
            } catch (error) {
                log(`Error fetching metrics: ${error.message}`, 'error');
            }
        }

        // Display metrics
        function displayMetrics(data) {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '';

            const metrics = [
                { title: 'System Uptime', value: data.systemMetrics?.uptime || 'N/A', unit: '' },
                { title: 'Memory Usage', value: data.systemMetrics?.memoryUsagePercent || 0, unit: '%' },
                { title: 'CPU Usage', value: data.systemMetrics?.cpuUsagePercent || 0, unit: '%' },
                { title: 'Cache Hit Rate', value: data.cacheMetrics?.hitRatePercent || 0, unit: '%' },
                { title: 'Cache Entries', value: data.cacheMetrics?.totalEntries || 0, unit: '' },
                { title: 'Total Exports', value: data.exportMetrics?.totalExports || 0, unit: '' },
                { title: 'Active Exports', value: data.exportMetrics?.activeExports || 0, unit: '' },
                { title: 'Export Success Rate', value: data.exportMetrics?.successRatePercent || 0, unit: '%' }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-title">${metric.title}</div>
                    <div class="metric-value">${metric.value}${metric.unit}</div>
                `;
                container.appendChild(card);
            });
        }

        // Auto refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(refreshMetrics, 5000);
            log('Auto refresh started (5s interval)', 'success');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('Auto refresh stopped', 'success');
            }
        }

        // Streaming export functions
        async function startEmployeeExport() {
            await startStreamingExport('employees', 'csv');
        }

        async function startEmployeeExportExcel() {
            await startStreamingExport('employees', 'excel');
        }

        async function startRawDataExport() {
            await startStreamingExport('rawdata', 'csv');
        }

        async function startStreamingExport(type, format) {
            if (exportAbortController) {
                exportAbortController.abort();
            }

            exportAbortController = new AbortController();
            const progressBar = document.getElementById('exportProgressBar');
            const progressText = document.getElementById('exportProgressText');
            const statusElement = document.getElementById('exportStatus');

            try {
                const endpoint = type === 'employees' 
                    ? `${API_BASE}/streamingexport/employees/stream?format=${format}`
                    : `${API_BASE}/streamingexport/rawdata/stream?format=${format}`;

                log(`Starting ${type} export (${format.toUpperCase()})...`);
                statusElement.textContent = `Exporting ${type}...`;

                const response = await fetch(endpoint, {
                    signal: exportAbortController.signal
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const progress = JSON.parse(line);
                                updateExportProgress(progress);
                            } catch (e) {
                                // Skip invalid JSON lines
                            }
                        }
                    }
                }

                log(`${type} export completed successfully`, 'success');
                statusElement.textContent = 'Export completed';
            } catch (error) {
                if (error.name === 'AbortError') {
                    log('Export cancelled', 'info');
                    statusElement.textContent = 'Export cancelled';
                } else {
                    log(`Export error: ${error.message}`, 'error');
                    statusElement.textContent = 'Export failed';
                }
            }
        }

        function updateExportProgress(progress) {
            const progressBar = document.getElementById('exportProgressBar');
            const progressText = document.getElementById('exportProgressText');
            
            progressBar.style.width = `${progress.percentComplete || 0}%`;
            progressText.textContent = `${progress.percentComplete || 0}%`;
            
            log(`Export Progress: ${progress.stage} - ${progress.processedRecords}/${progress.totalRecords} (${progress.percentComplete}%)`);
            
            if (progress.isCompleted) {
                log('Export stream completed', 'success');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Performance Dashboard Test initialized');
            checkSystemStatus();
            refreshMetrics();
        });
    </script>
</body>
</html>
