#!/bin/bash

# Script t·∫°o ƒë·∫ßy ƒë·ªß 46 ƒë∆°n v·ªã theo c·∫•u tr√∫c Ver2
# ƒê·∫£m b·∫£o kh√¥ng th·ª´a kh√¥ng thi·∫øu - S·ª≠ d·ª•ng ti·∫øng Vi·ªát

API_BASE="http://localhost:5055/api"
LOG_FILE="hoan_thien_46_don_vi_$(date +%Y%m%d_%H%M%S).log"
TIMESTAMP=$(date +%s)

echo "üéØ B·∫ÆT ƒê·∫¶U T·∫†O 46 ƒê∆†N V·ªä THEO C·∫§U TR√öC VER2..." | tee -a $LOG_FILE
echo "üìÖ B·∫Øt ƒë·∫ßu l√∫c: $(date)" | tee -a $LOG_FILE
echo "‚≠ê M·ª•c ti√™u: T·∫°o ch√≠nh x√°c 46 ƒë∆°n v·ªã (1 Root + 9 Chi nh√°nh + 36 Ph√≤ng ban)" | tee -a $LOG_FILE

# H√†m t·∫°o ƒë∆°n v·ªã v√† tr·∫£ v·ªÅ ID
tao_don_vi() {
    local ma_don_vi=$1
    local ten_don_vi=$2
    local loai_don_vi=$3
    local don_vi_cha=$4

    if [ "$don_vi_cha" == "null" ]; then
        du_lieu_json="{\"Code\": \"$ma_don_vi\", \"Name\": \"$ten_don_vi\", \"Type\": \"$loai_don_vi\", \"ParentUnitId\": null}"
    else
        du_lieu_json="{\"Code\": \"$ma_don_vi\", \"Name\": \"$ten_don_vi\", \"Type\": \"$loai_don_vi\", \"ParentUnitId\": $don_vi_cha}"
    fi

    phan_hoi=$(curl -s -X POST "$API_BASE/Units" -H "Content-Type: application/json" -d "$du_lieu_json")

    # Ki·ªÉm tra l·ªói
    if echo "$phan_hoi" | grep -q "error\|Error\|ƒë√£ t·ªìn t·∫°i"; then
        # N·∫øu ƒë√£ t·ªìn t·∫°i, th·ª≠ l·∫•y ID t·ª´ database
        if echo "$phan_hoi" | grep -q "ƒë√£ t·ªìn t·∫°i"; then
            echo "‚ö†Ô∏è $ten_don_vi ƒë√£ t·ªìn t·∫°i, ƒëang t√¨m ID..." | tee -a $LOG_FILE
            tat_ca_don_vi=$(curl -s "$API_BASE/Units")
            id=$(echo "$tat_ca_don_vi" | grep -A 5 -B 5 "\"Code\":\"$ma_don_vi\"" | grep '"Id":' | head -1 | sed 's/.*"Id": *\([0-9]*\).*/\1/')
            if [ -n "$id" ]; then
                echo "‚úÖ T√¨m th·∫•y $ten_don_vi (ID: $id)" | tee -a $LOG_FILE
                echo "$id"
                return 0
            fi
        fi
        echo "‚ùå L·ªói t·∫°o $ten_don_vi: $phan_hoi" | tee -a $LOG_FILE
        return 1
    fi

    # Tr√≠ch xu·∫•t ID t·ª´ ph·∫£n h·ªìi
    id=$(echo "$phan_hoi" | sed -n 's/.*"Id": *\([0-9]*\).*/\1/p')
    if [ -z "$id" ]; then
        echo "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y ID cho $ten_don_vi" | tee -a $LOG_FILE
        return 1
    fi

    echo "‚úÖ T·∫°o th√†nh c√¥ng $ten_don_vi (ID: $id)" | tee -a $LOG_FILE
    echo "$id"
}

# B∆Ø·ªöC 1: T·∫°o ƒë∆°n v·ªã g·ªëc - Chi nh√°nh Lai Ch√¢u
echo "" | tee -a $LOG_FILE
echo "üè¢ B∆Ø·ªöC 1: T·∫†O ƒê∆†N V·ªä G·ªêC..." | tee -a $LOG_FILE
ma_goc="CNLC_GOC_$TIMESTAMP"
id_goc=$(tao_don_vi "$ma_goc" "Chi nh√°nh Lai Ch√¢u" "CNL1" "null")

if [ -z "$id_goc" ]; then
    echo "‚ùå Kh√¥ng th·ªÉ t·∫°o ƒë∆°n v·ªã g·ªëc. Tho√°t!" | tee -a $LOG_FILE
    exit 1
fi

echo "üéâ ƒê∆°n v·ªã g·ªëc ƒë√£ t·∫°o: Chi nh√°nh Lai Ch√¢u (ID: $id_goc)" | tee -a $LOG_FILE

# B∆Ø·ªöC 2: T·∫°o 9 chi nh√°nh c·∫•p 2
echo "" | tee -a $LOG_FILE
echo "üè¢ B∆Ø·ªöC 2: T·∫†O 9 CHI NH√ÅNH C·∫§P 2..." | tee -a $LOG_FILE

# M·∫£ng ch·ª©a th√¥ng tin 9 chi nh√°nh
declare -a danh_sach_chi_nhanh=(
    "HS:H·ªôi s·ªü"
    "BL:CN B√¨nh L∆∞"
    "PT:CN Phong Th·ªï"
    "SH:CN S√¨n H·ªì"
    "BT:CN Bum T·ªü"
    "TU:CN Than Uy√™n"
    "DK:CN ƒêo√†n K·∫øt"
    "TUY:CN T√¢n Uy√™n"
    "NH:CN N·∫≠m H√†ng"
)

# M·∫£ng l∆∞u ID c·ªßa c√°c chi nh√°nh
declare -A id_chi_nhanh

so_chi_nhanh_thanh_cong=0
for chi_nhanh in "${danh_sach_chi_nhanh[@]}"; do
    ma_cn=$(echo "$chi_nhanh" | cut -d: -f1)
    ten_cn=$(echo "$chi_nhanh" | cut -d: -f2)
    ma_day_du="CN_${ma_cn}_$TIMESTAMP"

    echo "  ƒêang t·∫°o: $ten_cn..." | tee -a $LOG_FILE
    id_cn=$(tao_don_vi "$ma_day_du" "$ten_cn" "CNL2" "$id_goc")

    if [ -n "$id_cn" ]; then
        id_chi_nhanh[$ma_cn]=$id_cn
        so_chi_nhanh_thanh_cong=$((so_chi_nhanh_thanh_cong + 1))
        echo "  ‚úÖ $ten_cn t·∫°o th√†nh c√¥ng (ID: $id_cn)" | tee -a $LOG_FILE
    else
        echo "  ‚ùå Kh√¥ng th·ªÉ t·∫°o $ten_cn" | tee -a $LOG_FILE
    fi
done

echo "üìä K·∫øt qu·∫£: ƒê√£ t·∫°o $so_chi_nhanh_thanh_cong/9 chi nh√°nh" | tee -a $LOG_FILE

# B∆Ø·ªöC 3: T·∫°o ph√≤ng ban cho t·ª´ng chi nh√°nh
echo "" | tee -a $LOG_FILE
echo "üè¢ B∆Ø·ªöC 3: T·∫†O PH√íNG BAN CHO T·ª™NG CHI NH√ÅNH..." | tee -a $LOG_FILE

so_phong_ban_thanh_cong=0

# H√†m t·∫°o ph√≤ng ban cho m·ªôt chi nh√°nh
tao_phong_ban_cho_chi_nhanh() {
    local ma_cn=$1
    local id_cn=$2
    local ten_cn=$3
    shift 3
    local danh_sach_phong=("$@")
    local so_phong_tao_duoc=0

    echo "  üèõÔ∏è T·∫°o ph√≤ng ban cho $ten_cn (ID: $id_cn)..." | tee -a $LOG_FILE

    for thong_tin_phong in "${danh_sach_phong[@]}"; do
        local ma_phong=$(echo "$thong_tin_phong" | cut -d: -f1)
        local ten_phong=$(echo "$thong_tin_phong" | cut -d: -f2)
        local loai_phong=$(echo "$thong_tin_phong" | cut -d: -f3)
        local ma_phong_day_du="${ma_cn}_${ma_phong}_$TIMESTAMP"

        echo "    ƒêang t·∫°o: $ten_phong..." | tee -a $LOG_FILE
        id_phong=$(tao_don_vi "$ma_phong_day_du" "$ten_phong" "$loai_phong" "$id_cn")

        if [ -n "$id_phong" ]; then
            so_phong_tao_duoc=$((so_phong_tao_duoc + 1))
            echo "    ‚úÖ $ten_phong t·∫°o th√†nh c√¥ng (ID: $id_phong)" | tee -a $LOG_FILE
        else
            echo "    ‚ùå Kh√¥ng th·ªÉ t·∫°o $ten_phong" | tee -a $LOG_FILE
        fi

        sleep 0.1  # Tr√°nh qu√° t·∫£i API
    done

    echo "  üìã $ten_cn: ƒê√£ t·∫°o $so_phong_tao_duoc ph√≤ng ban" | tee -a $LOG_FILE
    echo "$so_phong_tao_duoc"
}

# T·∫°o ph√≤ng ban cho H·ªôi s·ªü (7 ph√≤ng)
if [ -n "${id_chi_nhanh[HS]}" ]; then
    phong_hoi_so=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL1"
        "KTNQ:P. KTNQ:PNVL1"
        "KHDN:P. KHDN:PNVL1"
        "KHCN:P. KHCN:PNVL1"
        "KTGS:P. KTGS:PNVL1"
        "TH:P. T·ªïng H·ª£p:PNVL1"
        "KHQLRR:P. KHQLRR:PNVL1"
    )
    so_phong_hs=$(tao_phong_ban_cho_chi_nhanh "HS" "${id_chi_nhanh[HS]}" "H·ªôi s·ªü" "${phong_hoi_so[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_hs))
fi

# T·∫°o ph√≤ng ban cho CN B√¨nh L∆∞ (3 ph√≤ng)
if [ -n "${id_chi_nhanh[BL]}" ]; then
    phong_binh_lu=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
    )
    so_phong_bl=$(tao_phong_ban_cho_chi_nhanh "BL" "${id_chi_nhanh[BL]}" "CN B√¨nh L∆∞" "${phong_binh_lu[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_bl))
fi

# T·∫°o ph√≤ng ban cho CN Phong Th·ªï (4 ph√≤ng: 3 ph√≤ng + 1 PGD)
if [ -n "${id_chi_nhanh[PT]}" ]; then
    phong_phong_tho=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
        "S5:PGD S·ªë 5:PGDL2"
    )
    so_phong_pt=$(tao_phong_ban_cho_chi_nhanh "PT" "${id_chi_nhanh[PT]}" "CN Phong Th·ªï" "${phong_phong_tho[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_pt))
fi

# T·∫°o ph√≤ng ban cho CN S√¨n H·ªì (3 ph√≤ng)
if [ -n "${id_chi_nhanh[SH]}" ]; then
    phong_sin_ho=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
    )
    so_phong_sh=$(tao_phong_ban_cho_chi_nhanh "SH" "${id_chi_nhanh[SH]}" "CN S√¨n H·ªì" "${phong_sin_ho[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_sh))
fi

# T·∫°o ph√≤ng ban cho CN Bum T·ªü (3 ph√≤ng)
if [ -n "${id_chi_nhanh[BT]}" ]; then
    phong_bum_to=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
    )
    so_phong_bt=$(tao_phong_ban_cho_chi_nhanh "BT" "${id_chi_nhanh[BT]}" "CN Bum T·ªü" "${phong_bum_to[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_bt))
fi

# T·∫°o ph√≤ng ban cho CN Than Uy√™n (4 ph√≤ng: 3 ph√≤ng + 1 PGD)
if [ -n "${id_chi_nhanh[TU]}" ]; then
    phong_than_uyen=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
        "S6:PGD S·ªë 6:PGDL2"
    )
    so_phong_tu=$(tao_phong_ban_cho_chi_nhanh "TU" "${id_chi_nhanh[TU]}" "CN Than Uy√™n" "${phong_than_uyen[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_tu))
fi

# T·∫°o ph√≤ng ban cho CN ƒêo√†n K·∫øt (5 ph√≤ng: 3 ph√≤ng + 2 PGD)
if [ -n "${id_chi_nhanh[DK]}" ]; then
    phong_doan_ket=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
        "S1:PGD S·ªë 1:PGDL2"
        "S2:PGD S·ªë 2:PGDL2"
    )
    so_phong_dk=$(tao_phong_ban_cho_chi_nhanh "DK" "${id_chi_nhanh[DK]}" "CN ƒêo√†n K·∫øt" "${phong_doan_ket[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_dk))
fi

# T·∫°o ph√≤ng ban cho CN T√¢n Uy√™n (4 ph√≤ng: 3 ph√≤ng + 1 PGD)
if [ -n "${id_chi_nhanh[TUY]}" ]; then
    phong_tan_uyen=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
        "S3:PGD S·ªë 3:PGDL2"
    )
    so_phong_tuy=$(tao_phong_ban_cho_chi_nhanh "TUY" "${id_chi_nhanh[TUY]}" "CN T√¢n Uy√™n" "${phong_tan_uyen[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_tuy))
fi

# T·∫°o ph√≤ng ban cho CN N·∫≠m H√†ng (3 ph√≤ng)
if [ -n "${id_chi_nhanh[NH]}" ]; then
    phong_nam_hang=(
        "BGD:Ban Gi√°m ƒë·ªëc:PNVL2"
        "KTNQ:P. KTNQ:PNVL2"
        "KH:P. KH:PNVL2"
    )
    so_phong_nh=$(tao_phong_ban_cho_chi_nhanh "NH" "${id_chi_nhanh[NH]}" "CN N·∫≠m H√†ng" "${phong_nam_hang[@]}")
    so_phong_ban_thanh_cong=$((so_phong_ban_thanh_cong + so_phong_nh))
fi

# B∆Ø·ªöC 4: Ki·ªÉm tra v√† th·ªëng k√™ cu·ªëi c√πng
echo "" | tee -a $LOG_FILE
echo "üîç B∆Ø·ªöC 4: KI·ªÇM TRA V√Ä TH·ªêNG K√ä CU·ªêI C√ôNG..." | tee -a $LOG_FILE

# ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ database c·∫≠p nh·∫≠t
sleep 3

# L·∫•y t·ªïng s·ªë ƒë∆°n v·ªã t·ª´ API
tat_ca_don_vi=$(curl -s "$API_BASE/Units")
tong_so_don_vi=$(echo "$tat_ca_don_vi" | grep -c '"Id":')

# ƒê·∫øm theo lo·∫°i
so_cnl1=$(echo "$tat_ca_don_vi" | grep -c '"Type":"CNL1"')
so_cnl2=$(echo "$tat_ca_don_vi" | grep -c '"Type":"CNL2"')
so_pnvl1=$(echo "$tat_ca_don_vi" | grep -c '"Type":"PNVL1"')
so_pnvl2=$(echo "$tat_ca_don_vi" | grep -c '"Type":"PNVL2"')
so_pgdl2=$(echo "$tat_ca_don_vi" | grep -c '"Type":"PGDL2"')

# T√≠nh s·ªë ƒë∆°n v·ªã m·ªõi t·∫°o
so_don_vi_moi=$((1 + so_chi_nhanh_thanh_cong + so_phong_ban_thanh_cong))

echo "üìä TH·ªêNG K√ä CU·ªêI C√ôNG:" | tee -a $LOG_FILE
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" | tee -a $LOG_FILE
echo "‚îÇ  LO·∫†I ƒê∆†N V·ªä  ‚îÇ  S·ªê L∆Ø·ª¢NG  ‚îÇ  TH·ª∞C T·∫æ  ‚îÇ" | tee -a $LOG_FILE
echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" | tee -a $LOG_FILE
echo "‚îÇ  CNL1 (G·ªëc)   ‚îÇ     1      ‚îÇ    $so_cnl1     ‚îÇ" | tee -a $LOG_FILE
echo "‚îÇ  CNL2 (CN)    ‚îÇ     9      ‚îÇ    $so_cnl2     ‚îÇ" | tee -a $LOG_FILE
echo "‚îÇ  PNVL1 (H·ªòI)  ‚îÇ     7      ‚îÇ    $so_pnvl1     ‚îÇ" | tee -a $LOG_FILE
echo "‚îÇ  PNVL2 (PB)   ‚îÇ    24      ‚îÇ    $so_pnvl2    ‚îÇ" | tee -a $LOG_FILE
echo "‚îÇ  PGDL2 (PGD)  ‚îÇ     5      ‚îÇ    $so_pgdl2     ‚îÇ" | tee -a $LOG_FILE
echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" | tee -a $LOG_FILE
echo "‚îÇ  T·ªîNG C·ªòNG    ‚îÇ    46      ‚îÇ    $tong_so_don_vi    ‚îÇ" | tee -a $LOG_FILE
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" | tee -a $LOG_FILE

echo "" | tee -a $LOG_FILE
echo "üìã CHI TI·∫æT QU√Å TR√åNH T·∫†O:" | tee -a $LOG_FILE
echo "  ‚úÖ ƒê∆°n v·ªã g·ªëc: 1/1 (Chi nh√°nh Lai Ch√¢u)" | tee -a $LOG_FILE
echo "  ‚úÖ Chi nh√°nh: $so_chi_nhanh_thanh_cong/9" | tee -a $LOG_FILE
echo "  ‚úÖ Ph√≤ng ban: $so_phong_ban_thanh_cong/36" | tee -a $LOG_FILE
echo "  üéØ T·ªïng ƒë√£ t·∫°o: $so_don_vi_moi ƒë∆°n v·ªã" | tee -a $LOG_FILE

# K·∫øt lu·∫≠n
echo "" | tee -a $LOG_FILE
if [ "$tong_so_don_vi" -ge 46 ]; then
    # T√¨m ƒë∆°n v·ªã g·ªëc m·ªõi t·∫°o
    don_vi_goc_moi=$(echo "$tat_ca_don_vi" | grep -B 2 -A 2 "\"Code\":\"$ma_goc\"" | grep '"Name":' | sed 's/.*"Name": *"\([^"]*\)".*/\1/')

    echo "üéâ TH√ÄNH C√îNG! ƒê√£ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u 46 ƒë∆°n v·ªã!" | tee -a $LOG_FILE
    echo "‚úÖ C·∫•u tr√∫c t·ªï ch·ª©c Ver2 ƒë√£ ƒë∆∞·ª£c t·∫°o ho√†n ch·ªânh" | tee -a $LOG_FILE
    echo "üè¢ ƒê∆°n v·ªã g·ªëc m·ªõi: $don_vi_goc_moi (M√£: $ma_goc)" | tee -a $LOG_FILE
    echo "üìà T·ªïng s·ªë ƒë∆°n v·ªã trong h·ªá th·ªëng: $tong_so_don_vi" | tee -a $LOG_FILE
else
    echo "‚ö†Ô∏è CH∆ØA ƒê·∫†T M·ª§C TI√äU! Hi·ªán t·∫°i ch·ªâ c√≥ $tong_so_don_vi ƒë∆°n v·ªã" | tee -a $LOG_FILE
    echo "üìã C·∫ßn t·∫°o th√™m: $((46 - tong_so_don_vi)) ƒë∆°n v·ªã" | tee -a $LOG_FILE
fi

echo "" | tee -a $LOG_FILE
echo "üìÖ Ho√†n th√†nh l√∫c: $(date)" | tee -a $LOG_FILE
echo "üìù Log chi ti·∫øt: $LOG_FILE" | tee -a $LOG_FILE
echo "üîö K·∫æT TH√öC SCRIPT T·∫†O 46 ƒê∆†N V·ªä" | tee -a $LOG_FILE
