-- üîç Script t·∫°o Views cho d·ªØ li·ªáu hi·ªán t·∫°i c·ªßa c√°c b·∫£ng SCD Type 2 m·ªõi
-- M·ªü r·ªông cho: LN03, EI01, DPDA, DB01, KH03, BC57
-- Thi·∫øt k·∫ø: Views hi·ªÉn th·ªã d·ªØ li·ªáu hi·ªán t·∫°i (IsCurrent = 1)

-- =======================================
-- üìä LN03_Current - View d·ªØ li·ªáu N·ª£ XLRR hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS LN03_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    MaHopDong,
    LoaiHopDong,
    SoTienGoc,
    SoTienLai,
    TongNo,
    NgayDaoHan,
    TinhTrangNo,
    NhomNo,
    MaChiNhanh,
    TenChiNhanh,
    NgayTao,
    NgayCapNhat,
    AdditionalData
FROM LN03_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä EI01_Current - View d·ªØ li·ªáu Mobile Banking hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS EI01_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    LoaiGiaoDich,
    MaGiaoDich,
    SoTien,
    NgayGiaoDich,
    ThoiGianGiaoDich,
    TrangThaiGiaoDich,
    NoiDungGiaoDich,
    MaChiNhanh,
    TenChiNhanh,
    Channel,
    DeviceInfo,
    AdditionalData
FROM EI01_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä DPDA_Current - View d·ªØ li·ªáu Ph√°t h√†nh th·∫ª hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS DPDA_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    SoThe,
    LoaiThe,
    TrangThaiThe,
    NgayPhatHanh,
    NgayHetHan,
    HanMucThe,
    SoDuHienTai,
    SoTienDaSD,
    MaChiNhanh,
    TenChiNhanh,
    NgayTao,
    NgayCapNhat,
    AdditionalData
FROM DPDA_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä DB01_Current - View d·ªØ li·ªáu TSDB hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS DB01_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    LoaiTaiKhoan,
    SoDu,
    SoDuKhaDung,
    NgayMoTK,
    TrangThaiTK,
    LaiSuat,
    KyHan,
    NgayDaoHan,
    SoTienGocGuy,
    TienLaiDuThu,
    MaChiNhanh,
    TenChiNhanh,
    LoaiHinhDB,
    AdditionalData
FROM DB01_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä KH03_Current - View d·ªØ li·ªáu Kh√°ch h√†ng ph√°p nh√¢n hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS KH03_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    MaSoThue,
    DiaChi,
    SoDienThoai,
    Email,
    NguoiDaiDien,
    ChucVuNDD,
    NgaySinh,
    CMND_CCCD,
    NgayCapCMND,
    NoiCapCMND,
    LoaiKhachHang,
    PhanKhuc,
    MaChiNhanh,
    TenChiNhanh,
    TrangThaiKH,
    NgayTao,
    NgayCapNhat,
    AdditionalData
FROM KH03_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä BC57_Current - View d·ªØ li·ªáu L√£i d·ª± thu hi·ªán t·∫°i
-- =======================================
CREATE VIEW IF NOT EXISTS BC57_Current AS
SELECT 
    Id,
    BusinessKey,
    EffectiveDate,
    RowVersion,
    ImportId,
    StatementDate,
    ProcessedDate,
    
    -- Business fields
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    MaHopDong,
    LoaiSanPham,
    SoTienGoc,
    LaiSuat,
    SoNgayTinhLai,
    TienLaiDuThu,
    TienLaiQuaHan,
    NgayBatDau,
    NgayKetThuc,
    TrangThai,
    MaChiNhanh,
    TenChiNhanh,
    NgayTinhLai,
    AdditionalData
FROM BC57_History 
WHERE IsCurrent = 1;

-- =======================================
-- üìä View th·ªëng k√™ t·ªïng h·ª£p cho t·∫•t c·∫£ b·∫£ng SCD Type 2
-- =======================================
CREATE VIEW IF NOT EXISTS AllTables_ImportStats AS
SELECT 
    'LN01' as TableName,
    'D·ªØ li·ªáu LOAN' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM LN01_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'LN03' as TableName,
    'D·ªØ li·ªáu N·ª£ XLRR' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM LN03_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'GL01' as TableName,
    'D·ªØ li·ªáu b√∫t to√°n GDV' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM GL01_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'DP01' as TableName,
    'D·ªØ li·ªáu Ti·ªÅn g·ª≠i' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM DP01_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'EI01' as TableName,
    'D·ªØ li·ªáu Mobile Banking' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM EI01_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'DPDA' as TableName,
    'D·ªØ li·ªáu Ph√°t h√†nh th·∫ª' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM DPDA_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'DB01' as TableName,
    'Sao k√™ TSDB v√† Kh√¥ng TSDB' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM DB01_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'KH03' as TableName,
    'Sao k√™ Kh√°ch h√†ng ph√°p nh√¢n' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM KH03_History
WHERE IsCurrent = 1

UNION ALL

SELECT 
    'BC57' as TableName,
    'Sao k√™ L√£i d·ª± thu' as Description,
    COUNT(*) as TotalRecords,
    COUNT(DISTINCT BusinessKey) as UniqueRecords,
    MAX(StatementDate) as LatestStatementDate,
    MAX(ProcessedDate) as LastProcessedDate,
    COUNT(DISTINCT ImportId) as ImportBatches
FROM BC57_History
WHERE IsCurrent = 1;

-- =======================================
-- üìä View l·ªãch s·ª≠ thay ƒë·ªïi cho t·ª´ng b·∫£ng
-- =======================================

-- View l·ªãch s·ª≠ thay ƒë·ªïi LN03
CREATE VIEW IF NOT EXISTS LN03_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    SoTienGoc,
    SoTienLai,
    TongNo,
    TinhTrangNo,
    NhomNo
FROM LN03_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- View l·ªãch s·ª≠ thay ƒë·ªïi EI01
CREATE VIEW IF NOT EXISTS EI01_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    LoaiGiaoDich,
    SoTien,
    TrangThaiGiaoDich
FROM EI01_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- View l·ªãch s·ª≠ thay ƒë·ªïi DPDA
CREATE VIEW IF NOT EXISTS DPDA_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    SoThe,
    TrangThaiThe,
    HanMucThe,
    SoDuHienTai
FROM DPDA_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- View l·ªãch s·ª≠ thay ƒë·ªïi DB01
CREATE VIEW IF NOT EXISTS DB01_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    SoDu,
    TrangThaiTK,
    LaiSuat
FROM DB01_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- View l·ªãch s·ª≠ thay ƒë·ªïi KH03
CREATE VIEW IF NOT EXISTS KH03_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    MaSoThue,
    DiaChi,
    TrangThaiKH,
    PhanKhuc
FROM KH03_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- View l·ªãch s·ª≠ thay ƒë·ªïi BC57
CREATE VIEW IF NOT EXISTS BC57_ChangeHistory AS
SELECT 
    BusinessKey,
    RowVersion,
    EffectiveDate,
    ExpiryDate,
    ImportId,
    StatementDate,
    ProcessedDate,
    IsCurrent,
    
    -- Key business fields for change tracking
    MaKhachHang,
    TenKhachHang,
    SoTaiKhoan,
    SoTienGoc,
    TienLaiDuThu,
    TrangThai
FROM BC57_History
ORDER BY BusinessKey, EffectiveDate DESC;

-- =======================================
-- üìä View t·ªïng h·ª£p import g·∫ßn ƒë√¢y
-- =======================================
CREATE VIEW IF NOT EXISTS Recent_AllTables_Imports AS
SELECT 
    'LN01' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM LN01_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'LN03' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM LN03_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'GL01' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM GL01_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'DP01' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM DP01_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'EI01' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM EI01_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'DPDA' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM DPDA_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'DB01' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM DB01_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'KH03' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM KH03_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

UNION ALL

SELECT 
    'BC57' as TableName,
    ImportId,
    StatementDate,
    ProcessedDate,
    COUNT(*) as RecordCount,
    MIN(ProcessedDate) as ImportStartTime,
    MAX(ProcessedDate) as ImportEndTime
FROM BC57_History
WHERE ProcessedDate >= datetime('now', '-30 days')
GROUP BY ImportId, StatementDate, ProcessedDate

ORDER BY ProcessedDate DESC;

-- ‚úÖ Views t·∫°o th√†nh c√¥ng
SELECT '‚úÖ Additional SCD Type 2 views created successfully!' as Status;
