Building...
âœ… Timezone set to: (UTC+07:00) Indochina Time (Bangkok)
ðŸš€ Starting TinhKhoan Backend API (Clean Version)...
ðŸŒ Backend will be available at: http://localhost:5055
âœ… All seeding code removed for stability
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (11ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL01_NGAY_DL' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL01_NGAY_DL ON dbo.GL01 (NGAY_DL); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (2ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL01_DEPT_CODE' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL01_DEPT_CODE ON dbo.GL01 (DEPT_CODE); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL01_TAI_KHOAN' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL01_TAI_KHOAN ON dbo.GL01 (TAI_KHOAN); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (7ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL01_TR_CODE' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL01_TR_CODE ON dbo.GL01 (TR_CODE); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (7ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL01_MA_KH' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL01_MA_KH ON dbo.GL01 (MA_KH); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'NCCI_GL01_Analytics' AND object_id = OBJECT_ID('dbo.GL01'))
                             BEGIN CREATE NONCLUSTERED INDEX NCCI_GL01_Analytics ON dbo.GL01 (NGAY_DL, DEPT_CODE, TAI_KHOAN, DR_CR, LOAI_TIEN); END
info: Khoan.Api.Services.Startup.Gl01IndexInitializer[0]
      âœ… GL01 analytics indexes ensured.
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL02_NGAY_DL' AND object_id = OBJECT_ID('dbo.GL02'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL02_NGAY_DL ON dbo.GL02 (NGAY_DL); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL02_UNIT' AND object_id = OBJECT_ID('dbo.GL02'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL02_UNIT ON dbo.GL02 (UNIT); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL02_TRCD' AND object_id = OBJECT_ID('dbo.GL02'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL02_TRCD ON dbo.GL02 (TRCD); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL02_CUSTOMER' AND object_id = OBJECT_ID('dbo.GL02'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_GL02_CUSTOMER ON dbo.GL02 (CUSTOMER); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'NCCI_GL02_Analytics' AND object_id = OBJECT_ID('dbo.GL02'))
                             BEGIN CREATE NONCLUSTERED INDEX NCCI_GL02_Analytics ON dbo.GL02 (NGAY_DL, UNIT, TRCD, CCY); END
info: Khoan.Api.Services.Startup.Gl02IndexInitializer[0]
      âœ… GL02 analytics indexes ensured.
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_NGAY_DL' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX IX_GL41_NGAY_DL ON dbo.GL41 (NGAY_DL); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_MA_CN' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX IX_GL41_MA_CN ON dbo.GL41 (MA_CN); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_LOAI_TIEN' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX IX_GL41_LOAI_TIEN ON dbo.GL41 (LOAI_TIEN); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_MA_TK' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX IX_GL41_MA_TK ON dbo.GL41 (MA_TK); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_LOAI_BT' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX IX_GL41_LOAI_BT ON dbo.GL41 (LOAI_BT); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'NCCI_GL41_Analytics' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX NCCI_GL41_Analytics ON dbo.GL41 (NGAY_DL, MA_CN, LOAI_TIEN, MA_TK, LOAI_BT); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'NCCI_GL41_Amounts' AND object_id = OBJECT_ID('dbo.GL41'))
                                    BEGIN CREATE NONCLUSTERED INDEX NCCI_GL41_Amounts ON dbo.GL41 (MA_TK, DN_DAUKY, DC_DAUKY, SBT_NO, SBT_CO); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      DECLARE @edition NVARCHAR(128) = CAST(SERVERPROPERTY('Edition') AS NVARCHAR(128));
                                    IF (@edition NOT LIKE '%Azure SQL Edge%')
                                    BEGIN
                                          IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_GL41_Columnstore' AND object_id = OBJECT_ID('dbo.GL41'))
                                          BEGIN
                                               BEGIN TRY
                                                    CREATE NONCLUSTERED COLUMNSTORE INDEX IX_GL41_Columnstore ON dbo.GL41
                                                    (
                                                          NGAY_DL, MA_CN, LOAI_TIEN, MA_TK, TEN_TK,
                                                          DN_DAUKY, DC_DAUKY, SBT_NO, ST_GHINO, SBT_CO, ST_GHICO, DN_CUOIKY, DC_CUOIKY
                                                    );
                                                    PRINT 'âœ… Created columnstore index IX_GL41_Columnstore';
                                               END TRY
                                               BEGIN CATCH
                                                    PRINT 'âš ï¸ Could not create columnstore index IX_GL41_Columnstore: ' + ERROR_MESSAGE();
                                               END CATCH
                                          END
                                    END
                                    ELSE
                                    BEGIN
                                          PRINT 'â„¹ï¸ Azure SQL Edge detected â€“ skipping columnstore index creation for GL41.';
                                    END
info: Khoan.Api.Services.Startup.Gl41IndexInitializer[0]
      âœ… GL41 analytics indexes ensured (temporal table safe).
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_LN03_NGAY_DL' AND object_id = OBJECT_ID('dbo.LN03'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_LN03_NGAY_DL ON dbo.LN03 (NGAY_DL); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_LN03_MACHINHANH' AND object_id = OBJECT_ID('dbo.LN03'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_LN03_MACHINHANH ON dbo.LN03 (MACHINHANH); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_LN03_MAKH' AND object_id = OBJECT_ID('dbo.LN03'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_LN03_MAKH ON dbo.LN03 (MAKH); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_LN03_MACBTD' AND object_id = OBJECT_ID('dbo.LN03'))
                             BEGIN CREATE NONCLUSTERED INDEX IX_LN03_MACBTD ON dbo.LN03 (MACBTD); END
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='120']
      IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'NCCI_LN03_Analytics' AND object_id = OBJECT_ID('dbo.LN03'))
                             BEGIN CREATE NONCLUSTERED INDEX NCCI_LN03_Analytics ON dbo.LN03 (NGAY_DL, MACHINHANH, MAKH, MACBTD); END
info: Khoan.Api.Services.Startup.Ln03IndexInitializer[0]
      âœ… LN03 analytics indexes ensured.
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5055
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /opt/Projects/Khoan/Backend/Khoan.Api
info: Khoan.Api.Controllers.DirectImportController[0]
      ðŸ” Detected DataType: DP01 tá»« filename: 7800_dp01_20241231.csv
info: Khoan.Api.Services.DirectImportService[0]
      ðŸš€ [DP01] Import DP01 from CSV: 7800_dp01_20241231.csv
fail: Khoan.Api.Services.DirectImportService[0]
      âŒ [DP01] CSV parsing error: Cannot implicitly convert type 'string' to 'decimal?'
      Microsoft.CSharp.RuntimeBinder.RuntimeBinderException: Cannot implicitly convert type 'string' to 'decimal?'
         at CallSite.Target(Closure, CallSite, Object)
         at System.Dynamic.UpdateDelegates.UpdateAndExecute1[T0,TRet](CallSite site, T0 arg0)
         at Khoan.Api.Services.DirectImportService.ParseDP01CsvAsync(IFormFile file) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 929
         at Khoan.Api.Services.DirectImportService.ParseDP01CsvAsync(IFormFile file) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 859
fail: Khoan.Api.Services.DirectImportService[0]
      âŒ [DP01] Import error: DP01 CSV parsing failed: Cannot implicitly convert type 'string' to 'decimal?'
      System.Exception: DP01 CSV parsing failed: Cannot implicitly convert type 'string' to 'decimal?'
       ---> Microsoft.CSharp.RuntimeBinder.RuntimeBinderException: Cannot implicitly convert type 'string' to 'decimal?'
         at CallSite.Target(Closure, CallSite, Object)
         at System.Dynamic.UpdateDelegates.UpdateAndExecute1[T0,TRet](CallSite site, T0 arg0)
         at Khoan.Api.Services.DirectImportService.ParseDP01CsvAsync(IFormFile file) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 929
         at Khoan.Api.Services.DirectImportService.ParseDP01CsvAsync(IFormFile file) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 859
         --- End of inner exception stack trace ---
         at Khoan.Api.Services.DirectImportService.ParseDP01CsvAsync(IFormFile file) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 941
         at Khoan.Api.Services.DirectImportService.ImportDP01Async(IFormFile file, String statementDate) in /opt/Projects/Khoan/Backend/Khoan.Api/Services/DirectImportService.cs:line 143
info: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
info: Khoan.Api.Services.Startup.Ln03IndexInitializer[0]
      âœ… LN03 Index Initializer completed successfully.
info: Khoan.Api.Services.Startup.Gl41IndexInitializer[0]
      âœ… GL41 Index Initializer completed successfully.
