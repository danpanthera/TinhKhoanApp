# Temporal Tables Migration Guide

## Overview

This folder contains SQL scripts to fully implement SQL Server Temporal Tables for the Agribank Lai Ch√¢u TinhKhoan application. Temporal tables provide automatic historical data tracking with built-in time-based querying capabilities.

## Files

1. `00_SetupAllTemporalTables.sql` - Master script that runs all scripts in sequence
2. `01_CreateTemporalRawDataImports.sql` - Creates temporal tables for raw data (existing file)
3. `02_EnableTemporalForKpiTables.sql` - Adds temporal capabilities to all KPI tables
4. `03_CreateColumnstoreIndexes.sql` - Creates columnstore indexes on history tables for performance
5. `04_VerifyTemporalConfiguration.sql` - Validates the configuration is correct
6. `05_ArchivingStrategy.sql` - Provides long-term archiving capabilities (existing file)

## Benefits of Temporal Tables

- **Automatic History Tracking**: All changes are automatically tracked with timestamps
- **Point-in-Time Analysis**: Query data as it existed at any point in time
- **Audit Trail**: Built-in auditing with no custom triggers or application code
- **Data Recovery**: Easily recover from accidental data changes
- **Improved Performance**: Columnstore indexes provide high compression and fast analytical queries

## How to Run

### Option 1: Run All Scripts

1. Connect to SQL Server Management Studio (SSMS)
2. Open `00_SetupAllTemporalTables.sql`
3. Execute the script (this will run all scripts in sequence)
4. Check the execution log for any errors

### Option 2: Run Individual Scripts

Run the scripts in this order:

1. `01_CreateTemporalRawDataImports.sql` (if not already executed)
2. `02_EnableTemporalForKpiTables.sql`
3. `03_CreateColumnstoreIndexes.sql`
4. `04_VerifyTemporalConfiguration.sql`

## Query Examples

### View Current Data
```sql
SELECT * FROM KPI_CN_MUONG_TE;
```

### View Historical Data
```sql
SELECT * FROM KPI_CN_MUONG_TE FOR SYSTEM_TIME ALL;
```

### View Data at a Specific Point in Time
```sql
SELECT * FROM KPI_CN_MUONG_TE FOR SYSTEM_TIME AS OF '2025-01-01 12:00:00';
```

### View Changes Between Two Points in Time
```sql
SELECT * FROM KPI_CN_MUONG_TE FOR SYSTEM_TIME BETWEEN '2025-01-01' AND '2025-02-01';
```

## Maintenance Recommendations

1. **Index Maintenance**:
   - Rebuild columnstore indexes every 3-6 months: `ALTER INDEX CIDX_TableName_History ON TableName_History REBUILD`

2. **Retention Policy**:
   - The default retention period is set to 7 years
   - Adjust this in the script if needed before running

3. **Monitoring**:
   - Check compression ratio: `SELECT object_name(object_id), * FROM sys.dm_db_column_store_row_group_physical_stats`
   - Monitor history table size growth

## Troubleshooting

If you encounter issues:

1. Check the ScriptExecutionLog table for errors
2. Run `04_VerifyTemporalConfiguration.sql` to identify configuration issues
3. Use the fix scripts generated by the verification script

## Additional Resources

- [SQL Server Temporal Tables Documentation](https://docs.microsoft.com/en-us/sql/relational-databases/tables/temporal-tables)
- [Columnstore Indexes Guide](https://docs.microsoft.com/en-us/sql/relational-databases/indexes/columnstore-indexes-overview)
- [Temporal Tables Best Practices](https://docs.microsoft.com/en-us/sql/relational-databases/tables/temporal-table-usage-scenarios)
