<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick KPI API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        .btn:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; }
        .error { color: #dc3545; border-left-color: #dc3545; }
        .success { color: #155724; border-left-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Quick KPI API Test</h1>
        
        <div class="section">
            <h3>Basic API Tests</h3>
            <button class="btn" onclick="testAPI('/KhoanPeriods')">Test Periods</button>
            <button class="btn" onclick="testAPI('/units')">Test Units</button>
            <button class="btn" onclick="testAPI('/employees')">Test Employees</button>
            <button class="btn" onclick="testAPI('/KpiAssignment/tables')">Test KPI Tables</button>
            <button class="btn" onclick="testKpiTableDetails()">Test KPI Table Details</button>
            <button class="btn" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="section">
            <h3>Debug Logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://localhost:7027/api';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (type === 'error') {
                logElement.classList.add('error');
                console.error(message);
            } else if (type === 'success') {
                console.log(message);
            }
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
            document.getElementById('logs').className = 'log';
        }

        async function testAPI(endpoint) {
            try {
                log(`🔄 Testing: ${endpoint}`);
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const count = Array.isArray(result) ? result.length : 'object';
                log(`✅ ${endpoint} - Success: ${count} items`, 'success');
                
                // Log sample data
                if (Array.isArray(result) && result.length > 0) {
                    const sample = result[0];
                    log(`   Sample: ${JSON.stringify(sample, null, 2).substring(0, 200)}...`);
                }
                
            } catch (error) {
                log(`❌ ${endpoint} - Error: ${error.message}`, 'error');
            }
        }

        async function testKpiTableDetails() {
            try {
                log('🔄 Testing KPI Table Details...');
                
                // First get all tables
                const tablesResponse = await fetch(`${API_BASE}/KpiAssignment/tables`);
                if (!tablesResponse.ok) {
                    throw new Error(`HTTP ${tablesResponse.status}: ${tablesResponse.statusText}`);
                }
                
                const tables = await tablesResponse.json();
                log(`✅ Found ${tables.length} KPI tables`);
                
                if (tables.length > 0) {
                    const firstTable = tables[0];
                    log(`🔍 Testing details for: ${firstTable.tableName} (ID: ${firstTable.id})`);
                    
                    // Test details endpoint
                    const detailsResponse = await fetch(`${API_BASE}/KpiAssignment/tables/${firstTable.id}`);
                    if (!detailsResponse.ok) {
                        throw new Error(`HTTP ${detailsResponse.status}: ${detailsResponse.statusText}`);
                    }
                    
                    const details = await detailsResponse.json();
                    log(`✅ Table details loaded:`, 'success');
                    log(`   Table Name: ${details.tableName || 'N/A'}`);
                    log(`   Indicators: ${details.indicators?.length || 0}`);
                    log(`   Category: ${details.category || 'N/A'}`);
                    log(`   Type: ${details.tableType || 'N/A'}`);
                    
                    if (details.indicators && details.indicators.length > 0) {
                        const sample = details.indicators[0];
                        log(`   Sample Indicator: ${sample.indicatorName} (${sample.maxScore} points)`);
                    }
                }
                
            } catch (error) {
                log(`❌ KPI Table Details - Error: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', function() {
            log('🚀 Quick KPI API Test initialized');
            log('Backend should be running at: https://localhost:7027');
            
            // Run basic tests automatically
            setTimeout(() => {
                testAPI('/KhoanPeriods');
                setTimeout(() => testAPI('/units'), 500);
                setTimeout(() => testAPI('/KpiAssignment/tables'), 1000);
                setTimeout(() => testKpiTableDetails(), 1500);
            }, 1000);
        });
    </script>
</body>
</html>
