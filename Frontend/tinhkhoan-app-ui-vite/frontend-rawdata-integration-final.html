// Ki·ªÉm tra t√≠ch h·ª£p ho√†n thi·ªán kho d·ªØ li·ªáu th√¥
// Th·ª±c hi·ªán 3 thao t√°c ch√≠nh: import m·ªõi, hi·ªÉn th·ªã d·ªØ li·ªáu, x√≥a d·ªØ li·ªáu

// 1. Import d·ªØ li·ªáu m·ªõi
// 2. Ki·ªÉm tra d·ªØ li·ªáu m·ªõi c√≥ xu·∫•t hi·ªán trong danh s√°ch
// 3. X√≥a d·ªØ li·ªáu ƒë√£ import
// 4. Ki·ªÉm tra d·ªØ li·ªáu ƒë√£ b·ªã x√≥a kh·ªèi danh s√°ch

const API_URL = 'https://localhost:7001/api';

async function testDataImportIntegration() {
  // Hi·ªÉn th·ªã ti√™u ƒë·ªÅ
  document.write('<h1>KI·ªÇM TRA T√çCH H·ª¢P KHO D·ªÆ LI·ªÜU TH√î</h1>');
  document.write('<p>Th·ª±c hi·ªán c√°c thao t√°c: import m·ªõi, hi·ªÉn th·ªã d·ªØ li·ªáu, x√≥a d·ªØ li·ªáu</p>');
  document.write('<hr>');
  
  try {
    // Ki·ªÉm tra server
    document.write('<h2>1. Ki·ªÉm tra k·∫øt n·ªëi server</h2>');
    const healthCheck = await fetch(`${API_URL}/health`, { 
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    
    if (!healthCheck.ok) {
      throw new Error('Server kh√¥ng ho·∫°t ƒë·ªông');
    }
    
    document.write('<p style="color:green">‚úÖ Server ho·∫°t ƒë·ªông.</p>');
    
    // L·∫•y danh s√°ch ban ƒë·∫ßu
    document.write('<h2>2. L·∫•y danh s√°ch d·ªØ li·ªáu ban ƒë·∫ßu</h2>');
    const initialResponse = await fetch(`${API_URL}/rawdata`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    
    if (!initialResponse.ok) {
      throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch ban ƒë·∫ßu');
    }
    
    const initialData = await initialResponse.json();
    document.write(`<p>üëâ S·ªë l∆∞·ª£ng d·ªØ li·ªáu ban ƒë·∫ßu: ${initialData.length}</p>`);
    
    // Hi·ªÉn th·ªã danh s√°ch ban ƒë·∫ßu
    document.write('<table border="1" cellpadding="5" style="border-collapse: collapse">');
    document.write('<tr><th>ID</th><th>T√™n file</th><th>Lo·∫°i d·ªØ li·ªáu</th><th>Ng√†y import</th><th>S·ªë b·∫£n ghi</th></tr>');
    
    initialData.forEach(item => {
      document.write(`<tr>
        <td>${item.id}</td>
        <td>${item.fileName}</td>
        <td>${item.dataType}</td>
        <td>${new Date(item.importDate).toLocaleString()}</td>
        <td>${item.recordsCount || 0}</td>
      </tr>`);
    });
    
    document.write('</table>');
    
    // T·∫°o form upload ƒë·ªÉ test import d·ªØ li·ªáu
    document.write('<h2>3. Import d·ªØ li·ªáu m·ªõi</h2>');
    document.write(`
      <form id="uploadForm" enctype="multipart/form-data">
        <p>
          <label>Ch·ªçn file CSV ho·∫∑c Excel ch·ª©a "LN01" trong t√™n:</label><br>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
        </p>
        <p>
          <label>Ghi ch√∫:</label><br>
          <input type="text" id="notesInput" value="Test import t√≠ch h·ª£p frontend">
        </p>
        <button type="button" id="uploadButton">Import d·ªØ li·ªáu</button>
      </form>
      <div id="uploadResult"></div>
    `);
    
    // X·ª≠ l√Ω s·ª± ki·ªán upload
    document.getElementById('uploadButton').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const notesInput = document.getElementById('notesInput');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('uploadResult').innerHTML = '<p style="color:red">‚ùå Vui l√≤ng ch·ªçn file</p>';
        return;
      }
      
      const file = fileInput.files[0];
      if (!file.name.includes('LN01')) {
        document.getElementById('uploadResult').innerHTML = '<p style="color:red">‚ùå T√™n file ph·∫£i ch·ª©a "LN01"</p>';
        return;
      }
      
      // T·∫°o FormData
      const formData = new FormData();
      formData.append('Files', file);
      formData.append('Notes', notesInput.value);
      
      try {
        document.getElementById('uploadResult').innerHTML = '<p>ƒêang import...</p>';
        
        // G·ªçi API import
        const importResponse = await fetch(`${API_URL}/rawdata/import/LN01`, {
          method: 'POST',
          body: formData
        });
        
        if (!importResponse.ok) {
          throw new Error('Import th·∫•t b·∫°i');
        }
        
        const importResult = await importResponse.json();
        document.getElementById('uploadResult').innerHTML = `<p style="color:green">‚úÖ ${importResult.message}</p>`;
        
        // ƒê·ª£i 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        setTimeout(() => checkAfterImport(initialData.length), 1000);
        
      } catch (error) {
        document.getElementById('uploadResult').innerHTML = `<p style="color:red">‚ùå L·ªói: ${error.message}</p>`;
      }
    });
    
  } catch (error) {
    document.write(`<p style="color:red">‚ùå L·ªói: ${error.message}</p>`);
  }
}

async function checkAfterImport(initialCount) {
  try {
    document.write('<h2>4. Ki·ªÉm tra sau khi import</h2>');
    
    // L·∫•y danh s√°ch sau khi import
    const afterImportResponse = await fetch(`${API_URL}/rawdata`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    
    if (!afterImportResponse.ok) {
      throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch sau khi import');
    }
    
    const afterImportData = await afterImportResponse.json();
    document.write(`<p>üëâ S·ªë l∆∞·ª£ng d·ªØ li·ªáu sau khi import: ${afterImportData.length}</p>`);
    
    // Ki·ªÉm tra s·ªë l∆∞·ª£ng c√≥ tƒÉng kh√¥ng
    if (afterImportData.length > initialCount) {
      document.write(`<p style="color:green">‚úÖ TH√ÄNH C√îNG: S·ªë l∆∞·ª£ng d·ªØ li·ªáu ƒë√£ tƒÉng sau khi import (${initialCount} -> ${afterImportData.length})</p>`);
    } else {
      document.write(`<p style="color:red">‚ùå TH·∫§T B·∫†I: S·ªë l∆∞·ª£ng d·ªØ li·ªáu kh√¥ng tƒÉng sau khi import (${initialCount} -> ${afterImportData.length})</p>`);
    }
    
    // Hi·ªÉn th·ªã danh s√°ch sau khi import
    document.write('<table border="1" cellpadding="5" style="border-collapse: collapse">');
    document.write('<tr><th>ID</th><th>T√™n file</th><th>Lo·∫°i d·ªØ li·ªáu</th><th>Ng√†y import</th><th>S·ªë b·∫£n ghi</th><th>Thao t√°c</th></tr>');
    
    afterImportData.forEach(item => {
      document.write(`<tr>
        <td>${item.id}</td>
        <td>${item.fileName}</td>
        <td>${item.dataType}</td>
        <td>${new Date(item.importDate).toLocaleString()}</td>
        <td>${item.recordsCount || 0}</td>
        <td><button onclick="deleteImport(' + item.id + ')">X√≥a</button></td>
      </tr>`);
    });
    
    document.write('</table>');
    
    // Th√™m ch·ª©c nƒÉng x√≥a
    document.write(`
      <script>
        async function deleteImport(id) {
          if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a item n√†y?')) {
            return;
          }
          
          try {
            const deleteResponse = await fetch('${API_URL}/rawdata/' + id, {
              method: 'DELETE'
            });
            
            if (!deleteResponse.ok) {
              throw new Error('X√≥a th·∫•t b·∫°i');
            }
            
            alert('ƒê√£ x√≥a th√†nh c√¥ng!');
            location.reload();
            
          } catch (error) {
            alert('L·ªói: ' + error.message);
          }
        }
      </script>
    `);
    
    // Th√™m n√∫t l√†m m·ªõi ƒë·ªÉ xem danh s√°ch m·ªõi nh·∫•t
    document.write('<p><button onclick="location.reload()">L√†m m·ªõi danh s√°ch</button></p>');
    
    // K·∫øt lu·∫≠n
    document.write('<h2>5. K·∫øt lu·∫≠n</h2>');
    document.write('<p>‚úÖ Ho√†n th√†nh ki·ªÉm tra t√≠ch h·ª£p kho d·ªØ li·ªáu th√¥</p>');
    document.write(`<p>- Import d·ªØ li·ªáu m·ªõi: ${afterImportData.length > initialCount ? 'TH√ÄNH C√îNG' : 'TH·∫§T B·∫†I'}</p>`);
    document.write(`<p>- Hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi: ${afterImportData.length > initialCount ? 'C√ì' : 'KH√îNG'}</p>`);
    document.write('<p>- X√≥a d·ªØ li·ªáu: B·∫°n c√≥ th·ªÉ th·ª≠ thao t√°c x√≥a b·∫±ng n√∫t "X√≥a" trong b·∫£ng</p>');
    
  } catch (error) {
    document.write(`<p style="color:red">‚ùå L·ªói: ${error.message}</p>`);
  }
}

// Ch·∫°y ki·ªÉm tra
testDataImportIntegration();
