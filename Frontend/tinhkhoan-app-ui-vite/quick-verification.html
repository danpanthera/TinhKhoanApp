<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Unit KPI Assignment - Quick Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            overflow-x: auto;
            font-size: 0.9em;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .result.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .result.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 Unit KPI Assignment - Quick Verification</h1>
        <p>Verify that the enhancement requirements have been successfully implemented</p>
    </div>

    <div class="test-section">
        <h2>✅ Requirement 1: CNL1 Display Fix</h2>
        <div class="status info">
            <p><strong>Expected:</strong> Table column "Chi nhánh CNL1" should show "Hội sở" instead of actual unit name</p>
            <p><strong>Status:</strong> ✅ IMPLEMENTED - Check table structure in source code</p>
        </div>
    </div>

    <div class="test-section">
        <h2>🎯 Requirement 2: Auto-load KPI Verification</h2>
        <button onclick="testKpiTableMapping()">Test KPI Table Mapping</button>
        <div id="mapping-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>📊 API Endpoint Tests</h2>
        <button onclick="testHoiSoTable()">Test HoiSo Table (CNL1)</button>
        <button onclick="testGiamdocCnl2Table()">Test GiamdocCnl2 Table (CNL2)</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🔄 Service Integration Test</h2>
        <button onclick="testServiceIntegration()">Test Frontend Service</button>
        <div id="service-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>📋 Manual Testing Instructions</h2>
        <div class="status">
            <h3>To verify manually:</h3>
            <ol>
                <li>Go to <a href="/unit-kpi-assignment" target="_blank">Unit KPI Assignment page</a></li>
                <li>Select a kỳ giao khoán and a chi nhánh</li>
                <li>Verify KPI indicators load automatically</li>
                <li>Click "Tạo giao khoán mới" to test modal</li>
                <li>Check that table shows "Hội sở" in first column</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5055/api';

        async function apiCall(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                throw new Error(`API call failed: ${error.message}`);
            }
        }

        function showResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.innerHTML = typeof result === 'string' ? result : `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        }

        async function testHoiSoTable() {
            try {
                showResult('api-result', 'Loading HoiSo table...', false);
                const data = await apiCall('/KpiAssignment/table/HoiSo');
                
                const indicators = data.indicators?.$values || data.indicators || [];
                const result = {
                    message: `✅ HoiSo Table Success!`,
                    tableName: data.tableName,
                    indicatorCount: indicators.length,
                    expectedCount: 11,
                    status: indicators.length === 11 ? 'CORRECT' : 'INCORRECT',
                    totalPoints: indicators.reduce((sum, ind) => sum + ind.maxScore, 0)
                };
                
                showResult('api-result', result, indicators.length !== 11);
            } catch (error) {
                showResult('api-result', `❌ HoiSo API Error: ${error.message}`, true);
            }
        }

        async function testGiamdocCnl2Table() {
            try {
                showResult('api-result', 'Loading GiamdocCnl2 table...', false);
                const data = await apiCall('/KpiAssignment/table/GiamdocCnl2');
                
                const indicators = data.indicators?.$values || data.indicators || [];
                const result = {
                    message: `✅ GiamdocCnl2 Table Success!`,
                    tableName: data.tableName,
                    indicatorCount: indicators.length,
                    expectedCount: 11,
                    status: indicators.length === 11 ? 'CORRECT' : 'INCORRECT',
                    totalPoints: indicators.reduce((sum, ind) => sum + ind.maxScore, 0)
                };
                
                showResult('api-result', result, indicators.length !== 11);
            } catch (error) {
                showResult('api-result', `❌ GiamdocCnl2 API Error: ${error.message}`, true);
            }
        }

        async function testKpiTableMapping() {
            try {
                showResult('mapping-result', 'Testing KPI table mapping...', false);
                
                const mappingTests = [
                    { unitType: 'CNL1', tableType: 'HoiSo', expectedName: 'Hội sở' },
                    { unitType: 'CNL2', tableType: 'GiamdocCnl2', expectedName: 'Giám đốc CNL2' }
                ];
                
                const results = [];
                
                for (const test of mappingTests) {
                    try {
                        const data = await apiCall(`/KpiAssignment/table/${test.tableType}`);
                        const indicators = data.indicators?.$values || data.indicators || [];
                        
                        results.push({
                            unitType: test.unitType,
                            tableType: test.tableType,
                            tableName: data.tableName,
                            indicatorCount: indicators.length,
                            isCorrect: data.tableName === test.expectedName && indicators.length === 11,
                            expectedName: test.expectedName,
                            actualName: data.tableName
                        });
                    } catch (error) {
                        results.push({
                            unitType: test.unitType,
                            tableType: test.tableType,
                            error: error.message,
                            isCorrect: false
                        });
                    }
                }
                
                const allCorrect = results.every(r => r.isCorrect);
                const summary = {
                    message: allCorrect ? '✅ All Mappings Correct!' : '❌ Some Mappings Incorrect',
                    results: results,
                    overallStatus: allCorrect ? 'PASS' : 'FAIL'
                };
                
                showResult('mapping-result', summary, !allCorrect);
            } catch (error) {
                showResult('mapping-result', `❌ Mapping test failed: ${error.message}`, true);
            }
        }

        async function testServiceIntegration() {
            try {
                showResult('service-result', 'Testing service integration...', false);
                
                // Test getting units
                const unitsData = await apiCall('/Units');
                const units = unitsData.$values || unitsData;
                const cnl1Units = units.filter(unit => unit.type === 'CNL1');
                const cnl2Units = units.filter(unit => unit.type === 'CNL2');
                
                // Test getting periods
                const periodsData = await apiCall('/KhoanPeriods');
                const periods = periodsData.$values || periodsData;
                
                const result = {
                    message: '✅ Service Integration Working!',
                    unitsAvailable: units.length,
                    cnl1Count: cnl1Units.length,
                    cnl2Count: cnl2Units.length,
                    periodsAvailable: periods.length,
                    branchDataStructure: {
                        cnl1_sample: cnl1Units[0] ? {
                            id: cnl1Units[0].id,
                            name: cnl1Units[0].name,
                            code: cnl1Units[0].code,
                            type: cnl1Units[0].type
                        } : null,
                        cnl2_sample: cnl2Units[0] ? {
                            id: cnl2Units[0].id,
                            name: cnl2Units[0].name,
                            code: cnl2Units[0].code,
                            type: cnl2Units[0].type
                        } : null
                    }
                };
                
                showResult('service-result', result);
            } catch (error) {
                showResult('service-result', `❌ Service integration failed: ${error.message}`, true);
            }
        }

        // Auto-run initial tests
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🧪 Quick Verification Page Loaded');
            // Automatically test API endpoints on load
            setTimeout(() => {
                testKpiTableMapping();
            }, 500);
        });
    </script>
</body>
</html>
