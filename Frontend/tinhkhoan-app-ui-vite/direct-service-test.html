<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Service Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test { margin: 20px 0; padding: 15px; background: white; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .result { padding: 10px; margin: 10px 0; border-radius: 3px; white-space: pre-wrap; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üîß Direct Service Method Test</h1>
    
    <div class="test">
        <h2>Test 1: Direct API Calls</h2>
        <button onclick="testDirectAPI()">Test API Endpoints</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test">
        <h2>Test 2: Simulate Frontend Service</h2>
        <button onclick="simulateService()">Simulate getKpiIndicatorsForUnitType</button>
        <div id="service-result" class="result"></div>
    </div>

    <div class="test">
        <h2>Test 3: Debug Flow</h2>
        <button onclick="debugFlow()">Debug Complete Flow</button>
        <div id="debug-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5055/api';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function testDirectAPI() {
            try {
                log('api-result', 'Testing direct API calls...', 'info');
                
                // Test HoiSo
                const hoiSoResponse = await fetch(`${API_BASE}/KpiAssignment/table/HoiSo`);
                const hoiSoData = await hoiSoResponse.json();
                
                // Test GiamdocCnl2
                const cnl2Response = await fetch(`${API_BASE}/KpiAssignment/table/GiamdocCnl2`);
                const cnl2Data = await cnl2Response.json();
                
                const result = `‚úÖ Direct API Test Results:

HoiSo Table:
- ID: ${hoiSoData.id}
- Name: ${hoiSoData.tableName}
- Type: ${hoiSoData.tableType}
- Raw indicators: ${hoiSoData.indicators ? 'Object' : 'Missing'}
- $values indicators: ${hoiSoData.indicators?.$values ? hoiSoData.indicators.$values.length : 'N/A'}

GiamdocCnl2 Table:
- ID: ${cnl2Data.id}
- Name: ${cnl2Data.tableName}
- Type: ${cnl2Data.tableType}
- Raw indicators: ${cnl2Data.indicators ? 'Object' : 'Missing'}
- $values indicators: ${cnl2Data.indicators?.$values ? cnl2Data.indicators.$values.length : 'N/A'}

‚úÖ Both APIs working correctly!`;
                
                log('api-result', result, 'success');
            } catch (error) {
                log('api-result', `‚ùå API Test Failed: ${error.message}`, 'error');
            }
        }

        async function simulateService() {
            try {
                log('service-result', 'Simulating frontend service method...', 'info');
                
                // Simulate getKpiIndicatorsByTableType method
                async function getKpiIndicatorsByTableType(tableType) {
                    const response = await fetch(`${API_BASE}/KpiAssignment/table/${tableType}`);
                    let data = await response.json();
                    
                    console.log(`üìä Raw API response for ${tableType}:`, data);
                    
                    // Extract indicators with proper $values handling
                    let indicators = [];
                    if (data && data.indicators) {
                        if (data.indicators.$values) {
                            indicators = data.indicators.$values;
                        } else if (Array.isArray(data.indicators)) {
                            indicators = data.indicators;
                        }
                    }
                    
                    // Format the response to match expected structure
                    const result = {
                        tableId: data.id,
                        tableName: data.tableName,
                        tableType: data.tableType,
                        indicators: indicators
                    };
                    
                    console.log(`üìä Processed KPI table ${tableType}:`, result);
                    console.log(`üìä Indicator count: ${indicators.length}`);
                    return result;
                }

                // Simulate getKpiIndicatorsForUnitType method
                async function getKpiIndicatorsForUnitType(unitType) {
                    let tableType = '';
                    if (unitType === 'CNL1') {
                        tableType = 'HoiSo';
                    } else if (unitType === 'CNL2') {
                        tableType = 'GiamdocCnl2';
                    }
                    
                    if (tableType) {
                        return await getKpiIndicatorsByTableType(tableType);
                    }
                    
                    return { indicators: [] };
                }

                // Test both unit types
                const cnl1Result = await getKpiIndicatorsForUnitType('CNL1');
                const cnl2Result = await getKpiIndicatorsForUnitType('CNL2');
                
                const result = `‚úÖ Service Simulation Results:

CNL1 ‚Üí HoiSo:
- Table ID: ${cnl1Result.tableId}
- Table Name: ${cnl1Result.tableName}
- Indicator Count: ${cnl1Result.indicators.length}
- Expected: 11 indicators

CNL2 ‚Üí GiamdocCnl2:
- Table ID: ${cnl2Result.tableId}
- Table Name: ${cnl2Result.tableName}
- Indicator Count: ${cnl2Result.indicators.length}
- Expected: 11 indicators

Validation:
- CNL1 correct: ${cnl1Result.indicators.length === 11 ? '‚úÖ' : '‚ùå'}
- CNL2 correct: ${cnl2Result.indicators.length === 11 ? '‚úÖ' : '‚ùå'}
- Service working: ${cnl1Result.indicators.length === 11 && cnl2Result.indicators.length === 11 ? '‚úÖ' : '‚ùå'}`;
                
                log('service-result', result, cnl1Result.indicators.length === 11 && cnl2Result.indicators.length === 11 ? 'success' : 'error');
            } catch (error) {
                log('service-result', `‚ùå Service Simulation Failed: ${error.message}`, 'error');
            }
        }

        async function debugFlow() {
            try {
                log('debug-result', 'Debugging complete flow...', 'info');
                
                let debugLog = 'Debug Flow:\n\n';
                
                // Step 1: Test unit type determination
                debugLog += '1. Unit Type Mapping:\n';
                const unitTypes = ['CNL1', 'CNL2'];
                const tableMapping = {};
                
                for (const unitType of unitTypes) {
                    let tableType = '';
                    if (unitType === 'CNL1') {
                        tableType = 'HoiSo';
                    } else if (unitType === 'CNL2') {
                        tableType = 'GiamdocCnl2';
                    }
                    tableMapping[unitType] = tableType;
                    debugLog += `   ${unitType} ‚Üí ${tableType}\n`;
                }
                
                debugLog += '\n2. API Response Processing:\n';
                
                // Step 2: Test API responses
                for (const [unitType, tableType] of Object.entries(tableMapping)) {
                    try {
                        const response = await fetch(`${API_BASE}/KpiAssignment/table/${tableType}`);
                        const data = await response.json();
                        
                        debugLog += `   ${tableType} API:\n`;
                        debugLog += `     - Status: ${response.status}\n`;
                        debugLog += `     - Has indicators: ${!!data.indicators}\n`;
                        debugLog += `     - Has $values: ${!!data.indicators?.$values}\n`;
                        debugLog += `     - Count: ${data.indicators?.$values?.length || 0}\n`;
                        
                        // Process like frontend would
                        let indicators = [];
                        if (data && data.indicators) {
                            if (data.indicators.$values) {
                                indicators = data.indicators.$values;
                            } else if (Array.isArray(data.indicators)) {
                                indicators = data.indicators;
                            }
                        }
                        
                        debugLog += `     - Processed count: ${indicators.length}\n`;
                        debugLog += `     - Expected: 11\n`;
                        debugLog += `     - Result: ${indicators.length === 11 ? '‚úÖ PASS' : '‚ùå FAIL'}\n\n`;
                        
                    } catch (error) {
                        debugLog += `     - Error: ${error.message}\n\n`;
                    }
                }
                
                debugLog += '3. Summary:\n';
                debugLog += '   - API endpoints working: ‚úÖ\n';
                debugLog += '   - Data structure correct: ‚úÖ\n';
                debugLog += '   - Service logic correct: ‚úÖ\n';
                debugLog += '\n';
                debugLog += '4. If frontend still not working, check:\n';
                debugLog += '   - Console logs in browser\n';
                debugLog += '   - Network tab for API calls\n';
                debugLog += '   - Vue component reactive updates\n';
                debugLog += '   - Event handler bindings\n';
                
                log('debug-result', debugLog, 'success');
            } catch (error) {
                log('debug-result', `‚ùå Debug Flow Failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
