<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test KPI Tables Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üß™ Test KPI Tables Fix - B3 & B4 Dropdown Issue</h1>

    <div class="section">
        <h2>üìä 1. Test KPI Assignment Tables API</h2>
        <div id="api-test-result">Loading...</div>
    </div>

    <div class="section">
        <h2>üë• 2. Test Employee KPI Tables (B3 - Giao kho√°n KPI theo C√°n b·ªô)</h2>
        <div id="employee-kpi-result">Loading...</div>
    </div>

    <div class="section">
        <h2>üè¢ 3. Test Unit KPI Tables (B4 - Giao kho√°n KPI theo Chi nh√°nh)</h2>
        <div id="unit-kpi-result">Loading...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5055/api';

        async function testKpiTablesAPI() {
            try {
                const response = await fetch(`${API_BASE}/KpiAssignmentTables`);
                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('API kh√¥ng tr·∫£ v·ªÅ array');
                }

                const totalTables = data.length;
                const tablesWithIndicators = data.filter(t => t.IndicatorCount > 0).length;
                const categories = [...new Set(data.map(t => t.Category))];

                let html = `
                    <div class="success">‚úÖ API ho·∫°t ƒë·ªông t·ªët!</div>
                    <ul>
                        <li><strong>T·ªïng s·ªë b·∫£ng KPI:</strong> ${totalTables}</li>
                        <li><strong>B·∫£ng c√≥ indicators:</strong> ${tablesWithIndicators}</li>
                        <li><strong>Categories:</strong> ${categories.join(', ')}</li>
                    </ul>
                `;

                // Show sample data
                html += `<h3>Sample data:</h3><table>
                    <tr><th>ID</th><th>Table Name</th><th>Description</th><th>Category</th><th>Indicators</th></tr>`;

                data.slice(0, 5).forEach(table => {
                    html += `<tr>
                        <td>${table.Id}</td>
                        <td>${table.TableName}</td>
                        <td>${table.Description}</td>
                        <td>${table.Category}</td>
                        <td>${table.IndicatorCount}</td>
                    </tr>`;
                });
                html += '</table>';

                document.getElementById('api-test-result').innerHTML = html;
                return data;

            } catch (error) {
                document.getElementById('api-test-result').innerHTML = `
                    <div class="error">‚ùå API Error: ${error.message}</div>
                `;
                return [];
            }
        }

        async function testEmployeeKpiTables(allTables) {
            try {
                // Filter tables for CANBO category (nh∆∞ trong EmployeeKpiAssignmentView)
                const staffTables = allTables.filter(table => table.Category === 'CANBO');

                let html = '';
                if (staffTables.length === 0) {
                    html = `<div class="error">‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng KPI n√†o cho c√°n b·ªô!</div>
                            <p>Ki·ªÉm tra category filter: ƒëang t√¨m 'CANBO'</p>`;
                } else {
                    html = `<div class="success">‚úÖ T√¨m th·∫•y ${staffTables.length} b·∫£ng KPI cho c√°n b·ªô!</div>`;

                    html += `<h3>Danh s√°ch b·∫£ng KPI cho c√°n b·ªô:</h3><table>
                        <tr><th>ID</th><th>M√¥ t·∫£</th><th>S·ªë indicators</th></tr>`;

                    staffTables.forEach(table => {
                        html += `<tr>
                            <td>${table.Id}</td>
                            <td>${table.Description}</td>
                            <td>${table.IndicatorCount}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                document.getElementById('employee-kpi-result').innerHTML = html;

            } catch (error) {
                document.getElementById('employee-kpi-result').innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        async function testUnitKpiTables(allTables) {
            try {
                // Filter tables for CHINHANH category (nh∆∞ trong UnitKpiAssignmentView)
                const branchTables = allTables.filter(table => table.Category === 'CHINHANH');

                let html = '';
                if (branchTables.length === 0) {
                    html = `<div class="error">‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng KPI n√†o cho chi nh√°nh!</div>
                            <p>Ki·ªÉm tra category filter: ƒëang t√¨m 'CHINHANH'</p>`;
                } else {
                    html = `<div class="success">‚úÖ T√¨m th·∫•y ${branchTables.length} b·∫£ng KPI cho chi nh√°nh!</div>`;

                    html += `<h3>Danh s√°ch b·∫£ng KPI cho chi nh√°nh:</h3><table>
                        <tr><th>ID</th><th>M√¥ t·∫£</th><th>S·ªë indicators</th></tr>`;

                    branchTables.forEach(table => {
                        html += `<tr>
                            <td>${table.Id}</td>
                            <td>${table.Description}</td>
                            <td>${table.IndicatorCount}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                document.getElementById('unit-kpi-result').innerHTML = html;

            } catch (error) {
                document.getElementById('unit-kpi-result').innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // Run tests
        async function runAllTests() {
            const allTables = await testKpiTablesAPI();
            if (allTables.length > 0) {
                await testEmployeeKpiTables(allTables);
                await testUnitKpiTables(allTables);
            }
        }

        // Start tests when page loads
        runAllTests();
    </script>
</body>
</html>
