<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß C·∫≠p nh·∫≠t t√™n chi nh√°nh v√† ƒë∆°n v·ªã t√≠nh</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .update-btn { background: #28a745; }
        .update-btn:hover { background: #218838; }
        .check-btn { background: #17a2b8; }
        .check-btn:hover { background: #138496; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß C·∫≠p nh·∫≠t t√™n chi nh√°nh v√† ƒë∆°n v·ªã t√≠nh</h1>

        <div class="test-section">
            <h3>1. Ki·ªÉm tra t√™n hi·ªán t·∫°i trong database</h3>
            <button onclick="checkCurrentNames()" class="check-btn">üîç Ki·ªÉm tra t√™n hi·ªán t·∫°i</button>
            <div id="checkResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. C·∫≠p nh·∫≠t t√™n chi nh√°nh v√† ƒë∆°n v·ªã t√≠nh</h3>
            <p><strong>Mapping s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng:</strong></p>
            <ul>
                <li>Chi nh√°nh Tam ƒê∆∞·ªùng ‚Üí <strong>Chi nh√°nh B√¨nh L∆∞</strong></li>
                <li>Chi nh√°nh M∆∞·ªùng T√® ‚Üí <strong>Chi nh√°nh Bum T·ªü</strong></li>
                <li>Chi nh√°nh Th√†nh Ph·ªë ‚Üí <strong>Chi nh√°nh ƒêo√†n K·∫øt</strong></li>
                <li>Chi nh√°nh N·∫≠m Nh√πn ‚Üí <strong>Chi nh√°nh N·∫≠m H√†ng</strong></li>
                <li>T·∫•t c·∫£ "T·ª∑ VND" ‚Üí <strong>"Tri·ªáu VND"</strong></li>
            </ul>
            <button onclick="updateNames()" class="update-btn">‚úÖ C·∫≠p nh·∫≠t Database</button>
            <div id="updateResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test API Ngu·ªìn v·ªën sau khi c·∫≠p nh·∫≠t</h3>
            <label>Chi nh√°nh:</label>
            <select id="branchSelect">
                <option value="CnLaiChau">CN Lai Ch√¢u (To√†n t·ªânh)</option>
                <option value="7801-00">CN B√¨nh L∆∞ (7801-00)</option>
                <option value="7806-00">CN ƒêo√†n K·∫øt (7806-00)</option>
                <option value="7808-00">CN N·∫≠m H√†ng (7808-00)</option>
            </select>
            <br>
            <label>Ng√†y 1:</label>
            <input type="date" id="testDate1" value="2024-12-31">
            <label>Ng√†y 2:</label>
            <input type="date" id="testDate2" value="2025-04-30">
            <br>
            <button onclick="testNguonVonAfterUpdate()">üí∞ Test Ngu·ªìn V·ªën</button>
            <div id="testResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Debug StatementDate trong database</h3>
            <button onclick="debugStatementDates()">üìÖ Ki·ªÉm tra StatementDate</button>
            <div id="statementResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5055/api';

        async function checkCurrentNames() {
            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = 'üîÑ ƒêang ki·ªÉm tra...';

            try {
                const response = await fetch(`${API_BASE}/UpdateData/check-branch-names`);
                const result = await response.json();

                if (result.success) {
                    let html = '<h4>‚úÖ K·∫øt qu·∫£ ki·ªÉm tra:</h4>';

                    html += '<h5>Units (CNL2):</h5><ul>';
                    result.units.forEach(unit => {
                        html += `<li><strong>${unit.code}</strong>: ${unit.name}</li>`;
                    });
                    html += '</ul>';

                    html += '<h5>KPI Tables (Chi nh√°nh):</h5><ul>';
                    result.kpiTables.forEach(table => {
                        html += `<li><strong>${table.tableType}</strong>: ${table.tableName}</li>`;
                    });
                    html += '</ul>';

                    html += '<h5>KPI Definitions c√≥ VND:</h5><ul>';
                    result.kpiDefinitionsWithVnd.forEach(kpi => {
                        html += `<li><strong>${kpi.name}</strong>: ${kpi.unit}</li>`;
                    });
                    html += '</ul>';

                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${result.error}</p>`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
                resultDiv.className = 'result error';
            }
        }

        async function updateNames() {
            const resultDiv = document.getElementById('updateResult');
            resultDiv.innerHTML = 'üîÑ ƒêang c·∫≠p nh·∫≠t database...';

            try {
                const response = await fetch(`${API_BASE}/UpdateData/update-branch-names`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    let html = '<h4>‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!</h4>';
                    html += `<p><strong>T·ªïng s·ªë thay ƒë·ªïi:</strong> ${result.summary.totalChanges}</p>`;
                    html += `<p><strong>Units c·∫≠p nh·∫≠t:</strong> ${result.summary.updatedUnits}</p>`;
                    html += `<p><strong>KPI Tables c·∫≠p nh·∫≠t:</strong> ${result.summary.updatedKpiTables}</p>`;
                    html += `<p><strong>KPI Definitions c·∫≠p nh·∫≠t:</strong> ${result.summary.updatedKpiDefinitions}</p>`;

                    html += '<h5>Mapping √°p d·ª•ng:</h5><ul>';
                    Object.entries(result.mappings).forEach(([oldName, newName]) => {
                        html += `<li>${oldName} ‚Üí <strong>${newName}</strong></li>`;
                    });
                    html += '</ul>';

                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${result.error}</p>`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
                resultDiv.className = 'result error';
            }
        }

        async function testNguonVonAfterUpdate() {
            const branchId = document.getElementById('branchSelect').value;
            const date1 = document.getElementById('testDate1').value;
            const date2 = document.getElementById('testDate2').value;
            const resultDiv = document.getElementById('testResult');

            resultDiv.innerHTML = 'üîÑ ƒêang test API Ngu·ªìn v·ªën...';

            try {
                // Test v·ªõi 2 ng√†y kh√°c nhau
                const [response1, response2] = await Promise.all([
                    fetch(`${API_BASE}/BranchIndicators/nguon-von`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ branchId, date: date1 })
                    }),
                    fetch(`${API_BASE}/BranchIndicators/nguon-von`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ branchId, date: date2 })
                    })
                ]);

                const result1 = await response1.json();
                const result2 = await response2.json();

                let html = '<h4>üí∞ K·∫øt qu·∫£ test Ngu·ªìn v·ªën:</h4>';
                html += `<p><strong>Chi nh√°nh:</strong> ${branchId}</p>`;
                html += `<p><strong>Ng√†y ${date1}:</strong> ${formatCurrency(result1.value)} tri·ªáu VND</p>`;
                html += `<p><strong>Ng√†y ${date2}:</strong> ${formatCurrency(result2.value)} tri·ªáu VND</p>`;

                if (result1.value === result2.value) {
                    html += `<p class="error">‚ùå <strong>V·∫§N ƒê·ªÄ:</strong> V·∫´n tr·∫£ v·ªÅ c√πng s·ªë li·ªáu!</p>`;
                    html += `<p>‚û°Ô∏è C·∫ßn debug th√™m logic filter theo ng√†y</p>`;
                } else {
                    html += `<p class="success">‚úÖ OK: C√≥ s·ª± kh√°c bi·ªát gi·ªØa 2 ng√†y</p>`;
                    const diff = Math.abs(result1.value - result2.value);
                    html += `<p><strong>Ch√™nh l·ªách:</strong> ${formatCurrency(diff)} tri·ªáu VND</p>`;
                }

                resultDiv.innerHTML = html;
                resultDiv.className = 'result';
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
                resultDiv.className = 'result error';
            }
        }

        async function debugStatementDates() {
            const resultDiv = document.getElementById('statementResult');
            resultDiv.innerHTML = 'üîÑ ƒêang ki·ªÉm tra StatementDate...';

            try {
                const response = await fetch(`${API_BASE}/DebugNguonVon/statement-dates`);
                const result = await response.json();

                if (result.success) {
                    let html = '<h4>üìÖ StatementDate trong database:</h4>';
                    html += `<p><strong>T·ªïng records DP01:</strong> ${result.totalRecords}</p>`;
                    html += `<p><strong>S·ªë ng√†y kh√°c nhau:</strong> ${result.dates.length}</p>`;

                    if (result.dates.length > 0) {
                        html += '<h5>Danh s√°ch ng√†y:</h5><ul>';
                        result.dates.forEach(dateInfo => {
                            html += `<li><strong>${dateInfo.vietnameseFormat}</strong> (${dateInfo.date}) - ${dateInfo.recordCount} records</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p class="warning">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu DP01 n√†o trong database!</p>';
                    }

                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${result.error || 'API error'}</p>`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
                resultDiv.className = 'result error';
            }
        }

        function formatCurrency(value) {
            if (typeof value === 'number') {
                return (value / 1000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 });
            }
            return value;
        }

        // Auto load ki·ªÉm tra t√™n hi·ªán t·∫°i
        window.onload = function() {
            checkCurrentNames();
        };
    </script>
</body>
</html>
