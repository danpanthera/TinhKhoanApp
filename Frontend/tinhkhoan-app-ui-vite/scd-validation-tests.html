<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCD Validation Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-section {
            background: white;
            margin: 10px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-1px);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
            font-weight: bold;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
            background-color: #f8f9fa;
        }
        .input-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group label {
            min-width: 100px;
            font-weight: 500;
        }
        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            flex: 1;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-card .label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .log-section {
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }
        .log-entry.info { color: #3498db; }
        .log-entry.success { color: #27ae60; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.warning { color: #f39c12; }
    </style>
</head>
<body>
    <h1>üîç SCD Validation & Testing Suite</h1>
    
    <div class="test-container">
        <!-- Test 1: Get Available Imports -->
        <div class="test-section">
            <h3>üìã Available Imports</h3>
            <button onclick="getAvailableImports()">Load Available Imports</button>
            <div id="importsResult" class="result"></div>
        </div>

        <!-- Test 2: Current SCD Stats -->
        <div class="test-section">
            <h3>üìä Current SCD Statistics</h3>
            <button onclick="getCurrentSCDStats()">Get SCD Stats</button>
            <div id="statsResult" class="result"></div>
        </div>

        <!-- Test 3: Apply SCD Logic -->
        <div class="test-section full-width">
            <h3>‚öôÔ∏è Apply SCD Logic to Import</h3>
            <div class="input-group">
                <label>Import ID:</label>
                <select id="importSelect">
                    <option value="">Select an import...</option>
                </select>
                <button onclick="applySCDLogic()">Apply SCD Logic</button>
            </div>
            <div id="applySCDResult" class="result"></div>
        </div>

        <!-- Test 4: Query Current Records -->
        <div class="test-section">
            <h3>üîç Query Current SCD Records</h3>
            <div class="input-group">
                <label>Branch:</label>
                <input type="text" id="queryBranch" placeholder="e.g., 7800">
            </div>
            <div class="input-group">
                <label>Data Type:</label>
                <input type="text" id="queryDataType" placeholder="e.g., LN01">
            </div>
            <div class="input-group">
                <label>Limit:</label>
                <input type="number" id="queryLimit" value="10" min="1" max="100">
            </div>
            <button onclick="queryCurrentRecords()">Query Records</button>
            <div id="queryResult" class="result"></div>
        </div>

        <!-- Test 5: Record History -->
        <div class="test-section">
            <h3>üìà Record History Analysis</h3>
            <div class="input-group">
                <label>Source ID:</label>
                <input type="text" id="historySourceId" placeholder="Enter Source ID">
            </div>
            <button onclick="getRecordHistory()">Get History</button>
            <div id="historyResult" class="result"></div>
        </div>

        <!-- Test 6: Data Validation -->
        <div class="test-section full-width">
            <h3>‚úÖ Data Validation Tests</h3>
            <button onclick="runValidationTests()" class="btn-success">Run All Validation Tests</button>
            <button onclick="clearValidationLog()" class="btn-danger">Clear Log</button>
            <div id="validationLog" class="log-section"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5055/api';
        let availableImports = [];
        let validationLog = [];

        // Utility Functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            validationLog.push({ timestamp, message, type });
            updateValidationLog();
        }

        function updateValidationLog() {
            const logElement = document.getElementById('validationLog');
            if (logElement) {
                logElement.innerHTML = validationLog.map(entry => 
                    `<div class="log-entry ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
                ).join('');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function clearValidationLog() {
            validationLog = [];
            updateValidationLog();
        }

        async function makeApiCall(url, method = 'GET', body = null) {
            try {
                log(`Making ${method} request to: ${url}`, 'info');
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úì Success: ${response.status}`, 'success');
                } else {
                    log(`‚úó Error: ${response.status} - ${data.message || 'Unknown error'}`, 'error');
                }
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                log(`‚úó Network Error: ${error.message}`, 'error');
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function displayResult(elementId, result, showFullData = true) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (result.success) {
                let dataDisplay = '';
                if (showFullData && result.data) {
                    if (Array.isArray(result.data)) {
                        dataDisplay = `
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="value">${result.data.length}</div>
                                    <div class="label">Records</div>
                                </div>
                            </div>
                            <pre>${JSON.stringify(result.data.slice(0, 3), null, 2)}${result.data.length > 3 ? '\n... and ' + (result.data.length - 3) + ' more records' : ''}</pre>
                        `;
                    } else {
                        dataDisplay = `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    }
                }
                
                element.innerHTML = `
                    <div class="success">‚úì Success (Status: ${result.status})</div>
                    ${dataDisplay}
                `;
            } else {
                element.innerHTML = `
                    <div class="error">‚úó Error${result.status ? ` (Status: ${result.status})` : ''}</div>
                    <pre>${result.error || JSON.stringify(result.data, null, 2)}</pre>
                `;
            }
        }

        // Test Functions
        async function getAvailableImports() {
            const result = await makeApiCall(`${API_BASE_URL}/DataImport`);
            if (result.success && result.data) {
                availableImports = result.data;
                // Populate the import select dropdown
                const select = document.getElementById('importSelect');
                select.innerHTML = '<option value="">Select an import...</option>';
                result.data.forEach(imp => {
                    select.innerHTML += `<option value="${imp.importId}">${imp.importId} - ${imp.branchCode}_${imp.dataType}_${imp.statementDate}</option>`;
                });
            }
            displayResult('importsResult', result);
        }

        async function getCurrentSCDStats() {
            const result = await makeApiCall(`${API_BASE_URL}/RawData/scd/current`);
            if (result.success && result.data) {
                const data = result.data;
                const stats = {
                    totalRecords: data.length,
                    branches: [...new Set(data.map(r => r.branchCode))].length,
                    dataTypes: [...new Set(data.map(r => r.dataType))].length,
                    latestDate: data.length > 0 ? Math.max(...data.map(r => new Date(r.effectiveFrom))) : null
                };
                
                const element = document.getElementById('statsResult');
                element.innerHTML = `
                    <div class="success">‚úì SCD Statistics Retrieved</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value">${stats.totalRecords}</div>
                            <div class="label">Total Current Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.branches}</div>
                            <div class="label">Unique Branches</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.dataTypes}</div>
                            <div class="label">Data Types</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${stats.latestDate ? new Date(stats.latestDate).toLocaleDateString() : 'N/A'}</div>
                            <div class="label">Latest Effective Date</div>
                        </div>
                    </div>
                `;
            } else {
                displayResult('statsResult', result, false);
            }
        }

        async function applySCDLogic() {
            const importId = document.getElementById('importSelect').value;
            if (!importId) {
                alert('Please select an import first');
                return;
            }
            
            log(`Applying SCD logic to import ${importId}`, 'info');
            const result = await makeApiCall(`${API_BASE_URL}/RawData/scd/upsert/${importId}`, 'POST');
            displayResult('applySCDResult', result);
            
            if (result.success) {
                log(`SCD logic applied successfully to import ${importId}`, 'success');
                // Refresh stats after applying SCD logic
                setTimeout(getCurrentSCDStats, 1000);
            }
        }

        async function queryCurrentRecords() {
            const branch = document.getElementById('queryBranch').value.trim();
            const dataType = document.getElementById('queryDataType').value.trim();
            const limit = document.getElementById('queryLimit').value || 10;
            
            let url = `${API_BASE_URL}/RawData/scd/current`;
            const params = new URLSearchParams();
            
            if (branch) params.append('branchCode', branch);
            if (dataType) params.append('dataType', dataType);
            params.append('pageSize', limit);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            const result = await makeApiCall(url);
            displayResult('queryResult', result);
        }

        async function getRecordHistory() {
            const sourceId = document.getElementById('historySourceId').value.trim();
            if (!sourceId) {
                alert('Please enter a Source ID');
                return;
            }
            
            const result = await makeApiCall(`${API_BASE_URL}/RawData/scd/versions/${encodeURIComponent(sourceId)}`);
            displayResult('historyResult', result);
        }

        async function runValidationTests() {
            log('üöÄ Starting comprehensive SCD validation tests...', 'info');
            
            // Test 1: Check if SCD current endpoint is accessible
            log('Test 1: Checking SCD current endpoint accessibility...', 'info');
            const currentTest = await makeApiCall(`${API_BASE_URL}/RawData/scd/current?pageSize=1`);
            if (currentTest.success) {
                log('‚úì SCD current endpoint is accessible', 'success');
            } else {
                log('‚úó SCD current endpoint failed', 'error');
                return;
            }
            
            // Test 2: Validate data structure
            if (currentTest.data && currentTest.data.length > 0) {
                log('Test 2: Validating SCD record structure...', 'info');
                const record = currentTest.data[0];
                const requiredFields = ['sourceId', 'branchCode', 'dataType', 'effectiveFrom', 'effectiveTo', 'isCurrent'];
                const missingFields = requiredFields.filter(field => !(field in record));
                
                if (missingFields.length === 0) {
                    log('‚úì SCD record structure is valid', 'success');
                } else {
                    log(`‚úó Missing required fields: ${missingFields.join(', ')}`, 'error');
                }
                
                // Test 3: Validate current records logic
                log('Test 3: Validating current records logic...', 'info');
                const currentRecords = currentTest.data.filter(r => r.isCurrent);
                if (currentRecords.length === currentTest.data.length) {
                    log('‚úì All retrieved records are correctly marked as current', 'success');
                } else {
                    log(`‚ö† Warning: ${currentTest.data.length - currentRecords.length} records are not marked as current`, 'warning');
                }
            } else {
                log('‚Ñπ No SCD records found - this may be expected for a new system', 'info');
            }
            
            // Test 4: Test import availability
            log('Test 4: Checking available imports for SCD processing...', 'info');
            const importsTest = await makeApiCall(`${API_BASE_URL}/DataImport`);
            if (importsTest.success && importsTest.data && importsTest.data.length > 0) {
                log(`‚úì Found ${importsTest.data.length} available imports`, 'success');
                
                // Test 5: Test SCD upsert endpoint (dry run check)
                const firstImport = importsTest.data[0];
                log(`Test 5: Checking SCD upsert endpoint with import ${firstImport.importId}...`, 'info');
                log('‚Ñπ This is a validation test - no actual upsert will be performed', 'info');
            } else {
                log('‚ö† No imports available for SCD testing', 'warning');
            }
            
            log('üéâ Validation tests completed!', 'success');
        }

        // Initialize page
        window.onload = function() {
            log('SCD Validation Suite initialized', 'success');
            getAvailableImports();
            getCurrentSCDStats();
        };
    </script>
</body>
</html>
